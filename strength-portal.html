<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Strength Portal | Athlete Academy</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Animated gradient background */
        .bg-animated {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(-45deg, #0f172a, #1e3a5f, #0f172a, #1a365d);
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
            z-index: -2;
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Floating particles */
        .particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            overflow: hidden;
        }

        .particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: rgba(59, 130, 246, 0.5);
            border-radius: 50%;
            animation: float 20s infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(100vh) rotate(0deg); opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { transform: translateY(-100vh) rotate(720deg); opacity: 0; }
        }

        /* Main container */
        .main-container {
            min-height: 100vh;
            padding: 20px;
            position: relative;
        }

        /* Welcome Screen */
        .welcome-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            text-align: center;
            padding: 40px 20px;
        }

        .welcome-logo {
            font-size: 80px;
            margin-bottom: 20px;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .welcome-title {
            font-size: clamp(2.5rem, 6vw, 4rem);
            font-weight: 800;
            background: linear-gradient(135deg, #60a5fa, #a78bfa, #f472b6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }

        .welcome-subtitle {
            font-size: 1.2rem;
            color: rgba(255,255,255,0.7);
            margin-bottom: 40px;
        }

        .privacy-notice {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 12px;
            padding: 15px 25px;
            margin-bottom: 30px;
            max-width: 500px;
        }

        .privacy-notice p {
            color: rgba(255,255,255,0.8);
            font-size: 0.9rem;
            line-height: 1.5;
        }

        /* Loading States */
        .loading-container {
            display: none;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            margin-top: 30px;
        }

        .loading-container.active {
            display: flex;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(255,255,255,0.1);
            border-top-color: #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            color: rgba(255,255,255,0.7);
            font-size: 0.95rem;
        }

        .loading-subtext {
            color: rgba(255,255,255,0.5);
            font-size: 0.85rem;
        }

        /* Portal (hidden until signed in) */
        .portal {
            display: none;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .portal.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 20px;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header-logo {
            font-size: 2.5rem;
        }

        .header-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: white;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255,255,255,0.1);
            padding: 8px 15px;
            border-radius: 50px;
        }

        .user-name {
            color: white;
            font-weight: 500;
            font-size: 0.9rem;
        }

        .back-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background: rgba(255,255,255,0.1);
            color: white;
            text-decoration: none;
            border-radius: 10px;
            font-weight: 500;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .back-btn:hover {
            background: rgba(255,255,255,0.15);
            border-color: rgba(255,255,255,0.2);
        }

        /* Glass Card Base */
        .glass-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 25px;
        }

        /* Section Title */
        .section-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: white;
            margin-bottom: 8px;
        }

        .section-subtitle {
            color: rgba(255,255,255,0.6);
            font-size: 0.9rem;
            margin-bottom: 25px;
        }

        /* Progress Overview */
        .progress-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 15px;
            margin-bottom: 30px;
        }

        @media (max-width: 900px) {
            .progress-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 500px) {
            .progress-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .progress-card {
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 15px;
            padding: 20px 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .progress-card:hover {
            background: rgba(255,255,255,0.08);
            border-color: rgba(59, 130, 246, 0.3);
            transform: translateY(-3px);
        }

        .progress-card.active {
            background: rgba(59, 130, 246, 0.15);
            border-color: rgba(59, 130, 246, 0.5);
        }

        .progress-pattern {
            font-size: 0.8rem;
            font-weight: 600;
            color: rgba(255,255,255,0.7);
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .progress-level {
            font-size: 2rem;
            font-weight: 800;
            background: linear-gradient(135deg, #60a5fa, #a78bfa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .progress-label {
            font-size: 0.7rem;
            color: rgba(255,255,255,0.5);
            margin-top: 5px;
        }

        /* Demo Section */
        .demo-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-bottom: 30px;
        }

        @media (max-width: 800px) {
            .demo-section {
                grid-template-columns: 1fr;
            }
        }

        .demo-card {
            background: rgba(255,255,255,0.03);
            border-radius: 15px;
            padding: 25px;
        }

        .demo-title {
            font-size: 1rem;
            font-weight: 600;
            color: white;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Level Selector */
        .level-selector {
            display: flex;
            align-items: center;
            gap: 15px;
            justify-content: center;
            margin-bottom: 20px;
        }

        .level-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255,255,255,0.1);
            border: none;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .level-btn:hover {
            background: rgba(255,255,255,0.2);
        }

        .level-display {
            text-align: center;
            min-width: 150px;
        }

        .level-number {
            font-size: 0.8rem;
            color: rgba(255,255,255,0.5);
            margin-bottom: 5px;
        }

        .level-name {
            font-size: 1.1rem;
            font-weight: 600;
            color: white;
        }

        /* Video Placeholder */
        .video-placeholder {
            background: rgba(0,0,0,0.3);
            border-radius: 12px;
            aspect-ratio: 16/9;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: rgba(255,255,255,0.5);
            margin-bottom: 15px;
        }

        .video-placeholder span {
            font-size: 3rem;
            margin-bottom: 10px;
        }

        /* Tips List */
        .tips-list {
            list-style: none;
        }

        .tips-list li {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            color: rgba(255,255,255,0.8);
            font-size: 0.9rem;
        }

        .tips-list li:last-child {
            border-bottom: none;
        }

        .tip-icon {
            font-size: 1.2rem;
            flex-shrink: 0;
        }

        /* Warning Box */
        .warning-box {
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid rgba(245, 158, 11, 0.3);
            border-radius: 12px;
            padding: 15px 20px;
            margin-top: 20px;
        }

        .warning-box h4 {
            color: #fbbf24;
            font-size: 0.9rem;
            margin-bottom: 8px;
        }

        .warning-box p {
            color: rgba(255,255,255,0.7);
            font-size: 0.85rem;
            line-height: 1.5;
        }

        /* Criteria Section */
        .criteria-section {
            margin-top: 25px;
        }

        .criteria-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .criteria-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: white;
        }

        .criteria-status {
            font-size: 0.8rem;
            color: #22c55e;
        }

        /* Checklist */
        .checklist {
            background: rgba(255,255,255,0.03);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
        }

        .checklist-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: white;
            margin-bottom: 15px;
            text-align: center;
        }

        .checklist-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 0;
            color: rgba(255,255,255,0.8);
            font-size: 0.9rem;
        }

        .checklist-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            accent-color: #3b82f6;
        }

        /* Submit Button */
        .submit-btn {
            display: block;
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
            text-align: center;
            text-decoration: none;
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(59, 130, 246, 0.4);
        }

        .submit-btn-note {
            text-align: center;
            color: rgba(255,255,255,0.5);
            font-size: 0.8rem;
            margin-top: 10px;
        }

        /* Strength Testing Section */
        .strength-section {
            margin-top: 30px;
            margin-bottom: 30px;
        }

        .strength-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .strength-pattern-card {
            background: rgba(255,255,255,0.03);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            border: 1px solid rgba(255,255,255,0.08);
        }

        .strength-pattern-card.locked {
            opacity: 0.6;
        }

        .strength-pattern-card.ready {
            border-color: rgba(59, 130, 246, 0.3);
            background: rgba(59, 130, 246, 0.05);
        }

        .strength-pattern-card.tested {
            border-color: rgba(34, 197, 94, 0.3);
            background: rgba(34, 197, 94, 0.05);
        }

        .strength-pattern-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .strength-pattern-name {
            font-size: 1.1rem;
            font-weight: 600;
            color: white;
        }

        .strength-pattern-status {
            font-size: 0.8rem;
            padding: 4px 10px;
            border-radius: 20px;
            font-weight: 500;
        }

        .strength-pattern-status.locked {
            background: rgba(107, 114, 128, 0.3);
            color: #9ca3af;
        }

        .strength-pattern-status.ready {
            background: rgba(59, 130, 246, 0.2);
            color: #60a5fa;
        }

        .strength-pattern-status.tested {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
        }

        .strength-exercise-name {
            font-size: 0.95rem;
            color: rgba(255,255,255,0.7);
            margin-bottom: 15px;
        }

        .testing-protocol {
            background: rgba(0,0,0,0.2);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .testing-protocol h4 {
            font-size: 0.85rem;
            color: #60a5fa;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .testing-protocol ol {
            margin: 0;
            padding-left: 20px;
            color: rgba(255,255,255,0.7);
            font-size: 0.9rem;
            line-height: 1.7;
        }

        .load-tiers {
            background: rgba(0,0,0,0.2);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .load-tiers h4 {
            font-size: 0.85rem;
            color: #fbbf24;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .load-tiers-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(50px, 1fr));
            gap: 8px;
        }

        @media (max-width: 500px) {
            .load-tiers-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        .load-tier {
            text-align: center;
            padding: 8px 5px;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
        }

        .load-tier-number {
            font-size: 0.7rem;
            color: rgba(255,255,255,0.5);
            margin-bottom: 3px;
        }

        .load-tier-weight {
            font-size: 0.9rem;
            font-weight: 600;
            color: white;
        }

        .load-tier-weight-f {
            font-size: 0.75rem;
            color: rgba(255,255,255,0.5);
            margin-top: 2px;
        }

        .safety-warning {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.2);
            border-radius: 10px;
            padding: 12px 15px;
        }

        .safety-warning-icon {
            font-size: 1.2rem;
            flex-shrink: 0;
        }

        .safety-warning-text {
            font-size: 0.9rem;
            color: #fca5a5;
            line-height: 1.5;
        }

        .tested-result {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: rgba(34, 197, 94, 0.1);
            border-radius: 10px;
        }

        .tested-result-value {
            font-size: 2rem;
            font-weight: 700;
            color: #22c55e;
        }

        .tested-result-label {
            font-size: 0.85rem;
            color: rgba(255,255,255,0.6);
        }

        .tested-result-info {
            font-size: 0.85rem;
            color: rgba(255,255,255,0.5);
            margin-top: 10px;
        }

        .locked-message {
            color: rgba(255,255,255,0.5);
            font-size: 0.9rem;
        }

        .locked-badge {
            display: flex;
            align-items: center;
            gap: 6px;
            background: rgba(239, 68, 68, 0.2);
            color: #fca5a5;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .unlocked-badge {
            display: flex;
            align-items: center;
            gap: 6px;
            background: rgba(34, 197, 94, 0.2);
            color: #86efac;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        /* ============================================ */
        /* WORKOUT SECTION - IMPROVED */
        /* ============================================ */
        .workout-section {
            margin-top: 40px;
            padding-top: 40px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        .workout-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 30px;
        }

        .workout-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .workout-title {
            font-size: 1.4rem;
            font-weight: 700;
            color: white;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .session-badge {
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            color: white;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .workout-actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        /* Loading State for Workout */
        .workout-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 20px;
            text-align: center;
        }

        .workout-loading .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255,255,255,0.1);
            border-top-color: #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        .workout-loading-text {
            color: rgba(255,255,255,0.7);
            font-size: 1rem;
        }

        .workout-loading-subtext {
            color: rgba(255,255,255,0.4);
            font-size: 0.85rem;
            margin-top: 5px;
        }

        /* Workout Content */
        .workout-content {
            display: none;
        }

        .workout-content.loaded {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        /* Session Info Bar */
        .session-info-bar {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            padding: 20px;
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.2);
            border-radius: 12px;
            margin-bottom: 25px;
        }

        @media (max-width: 600px) {
            .session-info-bar {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .session-info-item {
            text-align: center;
        }

        .session-info-label {
            font-size: 0.7rem;
            color: rgba(255,255,255,0.5);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .session-info-value {
            font-size: 1.1rem;
            font-weight: 600;
            color: white;
            margin-top: 4px;
        }

        /* Exercise Categories */
        .exercise-category {
            margin-bottom: 25px;
        }

        .category-title {
            font-size: 0.85rem;
            font-weight: 600;
            color: rgba(255,255,255,0.6);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .exercise-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 18px;
            background: rgba(255,255,255,0.03);
            border-radius: 12px;
            margin-bottom: 10px;
            border: 1px solid rgba(255,255,255,0.05);
            transition: all 0.2s ease;
        }

        .exercise-item:hover {
            background: rgba(255,255,255,0.06);
            border-color: rgba(255,255,255,0.1);
        }

        .exercise-info {
            flex: 1;
        }

        .exercise-name {
            font-size: 1rem;
            font-weight: 600;
            color: white;
            margin-bottom: 4px;
        }

        .exercise-details {
            font-size: 0.85rem;
            color: rgba(255,255,255,0.5);
        }

        .exercise-weight {
            background: rgba(59, 130, 246, 0.2);
            color: #60a5fa;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.9rem;
            white-space: nowrap;
        }

        /* Complete Session Button - MAIN FIX */
        .complete-session-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 14px 28px;
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 200px;
            box-shadow: 0 4px 15px rgba(34, 197, 94, 0.3);
        }

        .complete-session-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(34, 197, 94, 0.4);
        }

        .complete-session-btn:active {
            transform: translateY(0);
        }

        .complete-session-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .complete-session-btn .btn-icon {
            font-size: 1.1rem;
        }

        /* View History Button */
        .view-history-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 14px 20px;
            background: rgba(255,255,255,0.1);
            color: white;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 12px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .view-history-btn:hover {
            background: rgba(255,255,255,0.15);
            border-color: rgba(255,255,255,0.3);
        }

        /* Test Connection Button */
        .test-connection-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 14px 20px;
            background: rgba(34, 197, 94, 0.15);
            color: #22c55e;
            border: 1px solid rgba(34, 197, 94, 0.3);
            border-radius: 12px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .test-connection-btn:hover {
            background: rgba(34, 197, 94, 0.25);
        }

        /* Notes Section */
        .notes-section {
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        .notes-label {
            display: block;
            font-size: 0.85rem;
            color: rgba(255,255,255,0.6);
            margin-bottom: 10px;
        }

        .notes-input {
            width: 100%;
            padding: 15px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            color: white;
            font-size: 0.95rem;
            font-family: inherit;
            resize: vertical;
            min-height: 80px;
            transition: border-color 0.2s ease;
        }

        .notes-input::placeholder {
            color: rgba(255,255,255,0.3);
        }

        .notes-input:focus {
            outline: none;
            border-color: rgba(59, 130, 246, 0.5);
        }

        /* History Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.98), rgba(15, 23, 42, 0.98));
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 30px;
            max-width: 600px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .modal-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: white;
        }

        .modal-close {
            background: rgba(255,255,255,0.1);
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            color: white;
            font-size: 1.3rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .modal-close:hover {
            background: rgba(255,255,255,0.2);
        }

        .history-item {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 18px;
            margin-bottom: 12px;
            border: 1px solid rgba(255,255,255,0.05);
        }

        .history-date {
            font-size: 0.8rem;
            color: rgba(255,255,255,0.5);
            margin-bottom: 8px;
        }

        .history-session {
            font-size: 1rem;
            font-weight: 600;
            color: white;
            margin-bottom: 5px;
        }

        .history-notes {
            font-size: 0.85rem;
            color: rgba(255,255,255,0.6);
            font-style: italic;
        }

        .no-history {
            text-align: center;
            padding: 40px;
            color: rgba(255,255,255,0.5);
        }

        /* Toast Notifications */
        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            padding: 15px 25px;
            border-radius: 12px;
            color: white;
            font-weight: 500;
            z-index: 2000;
            animation: slideIn 0.3s ease;
            display: none;
        }

        .toast.success {
            background: linear-gradient(135deg, #22c55e, #16a34a);
        }

        .toast.error {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }

        .toast.active {
            display: block;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* ============================================ */
        /* WORKOUT TRACKING STYLES */
        /* ============================================ */
        
        /* Stats Counter Bar */
        .stats-counter {
            display: flex;
            gap: 20px;
            padding: 15px 20px;
            background: rgba(59, 130, 246, 0.1);
            border-radius: 12px;
            margin-bottom: 20px;
            border: 1px solid rgba(59, 130, 246, 0.2);
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 8px;
            color: white;
            font-weight: 600;
        }

        .stat-icon {
            font-size: 1.2rem;
        }

        .stat-value {
            color: #60a5fa;
        }

        /* Session Timer */
        .session-timer {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 20px;
            background: rgba(34, 197, 94, 0.1);
            border-radius: 10px;
            border: 1px solid rgba(34, 197, 94, 0.2);
        }

        .timer-icon {
            font-size: 1.3rem;
        }

        .timer-value {
            font-family: 'Courier New', monospace;
            font-size: 1.3rem;
            font-weight: 700;
            color: #22c55e;
        }

        .timer-label {
            font-size: 0.75rem;
            color: rgba(255,255,255,0.5);
            text-transform: uppercase;
        }

        /* Exercise Item with Checkbox */
        .exercise-item-tracked {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px 18px;
            background: rgba(255,255,255,0.03);
            border-radius: 12px;
            margin-bottom: 10px;
            border: 1px solid rgba(255,255,255,0.05);
            transition: all 0.2s ease;
        }

        .exercise-item-tracked:hover {
            background: rgba(255,255,255,0.06);
        }

        .exercise-item-tracked.completed {
            background: rgba(34, 197, 94, 0.1);
            border-color: rgba(34, 197, 94, 0.3);
        }

        .exercise-checkbox {
            width: 28px;
            height: 28px;
            border-radius: 8px;
            border: 2px solid rgba(255,255,255,0.3);
            background: transparent;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }

        .exercise-checkbox:hover {
            border-color: #22c55e;
        }

        .exercise-checkbox.checked {
            background: #22c55e;
            border-color: #22c55e;
        }

        .exercise-checkbox.checked::after {
            content: '‚úì';
            color: white;
            font-weight: bold;
            font-size: 16px;
        }

        .exercise-main {
            flex: 1;
        }

        /* Weight Adjuster */
        .weight-adjuster {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(59, 130, 246, 0.15);
            padding: 6px 12px;
            border-radius: 10px;
        }

        .weight-btn {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            border: none;
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .weight-btn:hover {
            background: rgba(255,255,255,0.2);
        }

        .weight-btn:active {
            transform: scale(0.95);
        }

        .weight-display {
            min-width: 70px;
            text-align: center;
            font-weight: 700;
            color: #60a5fa;
            font-size: 1rem;
        }

        /* Sloth Modal */
        .sloth-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            z-index: 3000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .sloth-modal.active {
            display: flex;
        }

        .sloth-content {
            text-align: center;
            max-width: 400px;
        }

        .sloth-emoji {
            font-size: 120px;
            margin-bottom: 20px;
            animation: slothSway 3s ease-in-out infinite;
        }

        @keyframes slothSway {
            0%, 100% { transform: rotate(-5deg); }
            50% { transform: rotate(5deg); }
        }

        .sloth-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: white;
            margin-bottom: 15px;
        }

        .sloth-message {
            font-size: 1.1rem;
            color: rgba(255,255,255,0.7);
            margin-bottom: 30px;
            line-height: 1.6;
        }

        .sloth-timer {
            font-size: 2.5rem;
            font-weight: 800;
            color: #f59e0b;
            font-family: 'Courier New', monospace;
            margin-bottom: 20px;
        }

        .sloth-tip {
            font-size: 0.9rem;
            color: rgba(255,255,255,0.5);
            padding: 15px;
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
        }

        /* Start Session Button */
        .start-session-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 16px 32px;
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
        }

        .start-session-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
        }

        /* Session Not Started State */
        .session-not-started {
            text-align: center;
            padding: 40px 20px;
        }

        .session-not-started-icon {
            font-size: 60px;
            margin-bottom: 20px;
        }

        .session-not-started-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: white;
            margin-bottom: 10px;
        }

        .session-not-started-text {
            color: rgba(255,255,255,0.6);
            margin-bottom: 25px;
        }

        /* Reps counter in exercise */
        .reps-info {
            font-size: 0.85rem;
            color: rgba(255,255,255,0.6);
            margin-top: 4px;
        }

        /* ============================================ */
        /* VISUAL WORKOUT BLOCKS */
        /* ============================================ */
        
        .workout-block-container {
            position: relative;
        }

        .workout-block {
            background: rgba(255,255,255,0.03);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .block-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 12px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .block-nav-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background: rgba(255,255,255,0.1);
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .block-nav-btn:hover:not(:disabled) {
            background: rgba(255,255,255,0.2);
        }

        .block-nav-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .block-title-area {
            text-align: center;
        }

        .block-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: white;
            margin-bottom: 5px;
        }

        .block-subtitle {
            font-size: 0.85rem;
            color: rgba(255,255,255,0.5);
        }

        .block-progress-dots {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-top: 10px;
        }

        .progress-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .progress-dot.active {
            background: #3b82f6;
            transform: scale(1.2);
        }

        .progress-dot.completed {
            background: #22c55e;
        }

        /* Video Container - Compact */
        .block-video-container {
            width: 100%;
            max-width: 400px;
            margin: 0 auto 20px;
            border-radius: 12px;
            overflow: hidden;
            background: rgba(0,0,0,0.3);
            aspect-ratio: 16/9;
        }

        .block-video-container iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        .block-video-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .video-thumbnail-wrapper {
            position: relative;
            width: 100%;
            height: 100%;
        }

        .video-play-btn {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 60px;
            height: 60px;
            background: rgba(0,0,0,0.7);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .block-video-container:hover .video-play-btn {
            background: rgba(255,0,0,0.9);
            transform: translate(-50%, -50%) scale(1.1);
        }

        .video-play-btn span {
            color: white;
            font-size: 24px;
            margin-left: 4px;
        }

        /* No Video - Instructions */
        .block-instructions {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.2);
            border-radius: 12px;
            padding: 20px;
            margin: 0 auto 25px;
            max-width: 600px;
        }

        .block-instructions h4 {
            color: #60a5fa;
            font-size: 1rem;
            margin-bottom: 12px;
        }

        .block-instructions ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .block-instructions li {
            color: rgba(255,255,255,0.8);
            padding: 8px 0;
            padding-left: 25px;
            position: relative;
            font-size: 0.95rem;
        }

        .block-instructions li::before {
            content: '‚Ä¢';
            position: absolute;
            left: 8px;
            color: #60a5fa;
        }

        /* Exercise Info in Block */
        .block-exercise-info {
            text-align: center;
            margin-bottom: 15px;
        }

        .block-exercise-name {
            font-size: 1.3rem;
            font-weight: 700;
            color: white;
            margin-bottom: 5px;
        }

        .block-exercise-details {
            font-size: 0.95rem;
            color: rgba(255,255,255,0.6);
        }

        .block-exercise-pattern {
            display: inline-block;
            background: rgba(59, 130, 246, 0.2);
            color: #60a5fa;
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            margin-top: 8px;
        }

        /* Weight Control in Block */
        .block-weight-control {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin: 15px 0;
        }

        .block-weight-btn {
            width: 44px;
            height: 44px;
            border-radius: 10px;
            border: none;
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 1.3rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .block-weight-btn:hover {
            background: rgba(255,255,255,0.2);
        }

        .block-weight-display {
            font-size: 1.8rem;
            font-weight: 700;
            color: #60a5fa;
            min-width: 100px;
            text-align: center;
        }

        .block-weight-label {
            font-size: 0.75rem;
            color: rgba(255,255,255,0.5);
            text-align: center;
            margin-top: 3px;
        }

        /* Sets Grid */
        .sets-grid {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .set-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
        }

        .set-checkbox {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            border: 3px solid rgba(255,255,255,0.2);
            background: transparent;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            font-size: 20px;
        }

        .set-checkbox:hover {
            border-color: #22c55e;
            background: rgba(34, 197, 94, 0.1);
        }

        .set-checkbox.checked {
            background: #22c55e;
            border-color: #22c55e;
        }

        .set-checkbox.checked::after {
            content: '‚úì';
            color: white;
            font-weight: bold;
        }

        .set-label {
            font-size: 0.9rem;
            color: rgba(255,255,255,0.6);
        }

        .set-reps {
            font-size: 0.8rem;
            color: rgba(255,255,255,0.4);
        }

        /* Block Tip */
        .block-tip {
            text-align: center;
            padding: 15px;
            background: rgba(245, 158, 11, 0.1);
            border-radius: 10px;
            margin-top: 20px;
        }

        .block-tip-text {
            color: #fbbf24;
            font-size: 0.9rem;
        }

        /* Complete Block Button */
        .complete-block-btn {
            display: block;
            width: 100%;
            max-width: 300px;
            margin: 25px auto 0;
            padding: 15px 30px;
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .complete-block-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(34, 197, 94, 0.3);
        }

        .complete-block-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Summary Block */
        .summary-block {
            text-align: center;
        }

        .summary-icon {
            font-size: 80px;
            margin-bottom: 20px;
        }

        .summary-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: white;
            margin-bottom: 10px;
        }

        .summary-stats {
            display: flex;
            justify-content: center;
            gap: 40px;
            margin: 30px 0;
            flex-wrap: wrap;
        }

        .summary-stat {
            text-align: center;
        }

        .summary-stat-value {
            font-size: 2.5rem;
            font-weight: 800;
            color: #22c55e;
        }

        .summary-stat-label {
            font-size: 0.9rem;
            color: rgba(255,255,255,0.5);
        }

        .summary-exercises {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            text-align: left;
        }

        .summary-exercise-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            color: rgba(255,255,255,0.7);
        }

        .summary-exercise-item:last-child {
            border-bottom: none;
        }

        .summary-exercise-item.completed {
            color: #22c55e;
        }

        .summary-exercise-item.completed::before {
            content: '‚úì ';
        }
    </style>
</head>
<body>
    <!-- Animated Background -->
    <div class="bg-animated"></div>
    <div class="particles" id="particles"></div>

    <!-- Welcome Screen -->
    <div class="welcome-screen" id="welcomeScreen">
        <div class="welcome-logo">üèÜ</div>
        <h1 class="welcome-title">Athlete Academy</h1>
        <p class="welcome-subtitle">Master your technique, unlock your strength potential</p>
        
        <div class="privacy-notice">
            <p><strong>Privacy Notice:</strong> This system tracks your athletic development. 
            Only you and your teacher can see your data. Sign in with your school Google account.</p>
        </div>

        <!-- Google Sign-In -->
        <div id="g_id_onload"
             data-client_id="701639243214-ud6m1qtmc6ma0pq6v24tk39afbuhcblv.apps.googleusercontent.com"
             data-context="signin"
             data-ux_mode="popup"
             data-callback="handleCredentialResponse"
             data-auto_prompt="false">
        </div>
        <div class="g_id_signin"
             data-type="standard"
             data-shape="rectangular"
             data-theme="filled_blue"
             data-text="signin_with"
             data-size="large"
             data-logo_alignment="left">
        </div>

        <div class="loading-container" id="loadingContainer">
            <div class="spinner"></div>
            <p class="loading-text" id="loadingText">Loading your strength portal...</p>
            <p class="loading-subtext">Fetching data from Google Sheets...</p>
        </div>
    </div>

    <!-- Main Portal -->
    <div class="main-container">
        <div class="portal" id="portal">
            <!-- Header -->
            <header class="header">
                <div class="header-left">
                    <span class="header-logo">üèãÔ∏è</span>
                    <h1 class="header-title">Strength Portal</h1>
                </div>
                <div class="header-right">
                    <div class="user-info">
                        <span class="user-name" id="userName">Athlete</span>
                    </div>
                    <a href="index.html" class="back-btn">‚Üê Back to Dashboard</a>
                </div>
            </header>

            <!-- Movement Assessment Card -->
            <div class="glass-card" id="movementAssessment">
                <h2 class="section-title">üìπ Movement Assessment</h2>
                <p class="section-subtitle">Track your progress, develop your skills</p>

                <!-- Progress Overview -->
                <h3 style="color: rgba(255,255,255,0.7); font-size: 0.9rem; margin-bottom: 15px;">üìä Your Progress</h3>
                <div class="progress-grid" id="progressGrid">
                    <!-- Filled by JavaScript -->
                </div>

                <!-- Demo Section -->
                <div class="demo-section">
                    <!-- Video Demo Card -->
                    <div class="demo-card">
                        <div class="demo-title">üìπ Exercise Demo</div>
                        <div id="patternName" style="color: #60a5fa; font-weight: 600; margin-bottom: 15px;">Squat</div>
                        
                        <div class="level-selector">
                            <button class="level-btn" onclick="changeLevel(-1)">‚óÑ</button>
                            <div class="level-display">
                                <div class="level-number">Level <span id="currentLevel">1</span></div>
                                <div class="level-name" id="exerciseName">Bodyweight Squat</div>
                            </div>
                            <button class="level-btn" onclick="changeLevel(1)">‚ñ∫</button>
                        </div>

                        <div class="video-placeholder" id="videoPlaceholder">
                            <span>üé¨</span>
                            <p>Select a pattern to view demo</p>
                        </div>

                        <div class="warning-box" id="level5Warning" style="display: none;">
                            <h4>‚ö†Ô∏è Level 5 - Olympic Lifts</h4>
                            <p><strong>Instructor supervision required.</strong><br>
                            Level 5 Olympic lifting variations (Power Clean, Squat Clean, Split Jerk, Clean Pull) must be taught and cleared by a qualified instructor before attempting.</p>
                        </div>
                    </div>

                    <!-- Tips Card - For technique levels only -->
                    <div class="demo-card" id="filmingTipsCard">
                        <div class="demo-title">üì± Filming Tips</div>
                        <ul class="tips-list">
                            <li>
                                <span class="tip-icon">üìê</span>
                                <span>Film from the <strong>side angle</strong> - full body visible</span>
                            </li>
                            <li>
                                <span class="tip-icon">üî¢</span>
                                <span>Perform <strong>5 clear reps</strong> with controlled tempo</span>
                            </li>
                            <li>
                                <span class="tip-icon">üí°</span>
                                <span>Good lighting, clear background, phone horizontal</span>
                            </li>
                        </ul>

                        <div class="criteria-section">
                            <div class="criteria-header">
                                <span class="criteria-title">‚úì Form Criteria</span>
                                <span class="criteria-status">Pass: 5/6 on all reps</span>
                            </div>
                            <div id="criteriaList" style="color: rgba(255,255,255,0.6); font-size: 0.85rem;">
                                <!-- Filled by JavaScript -->
                            </div>
                        </div>
                    </div>

                    <!-- Strength Test Info Card - For 3T level only -->
                    <div class="demo-card" id="strengthTestCard" style="display: none;">
                        <div class="demo-title">üèãÔ∏è Strength Test Info</div>
                        <div id="strengthTestContent">
                            <!-- Filled by JavaScript -->
                        </div>
                    </div>
                </div>

                <!-- Submission Checklist - Only for technique levels -->
                <div class="checklist" id="submissionChecklist">
                    <div class="checklist-title">üéØ Ready to Submit?</div>
                    <div class="checklist-item">
                        <input type="checkbox" id="check1">
                        <label for="check1">I can perform 5 reps hitting all criteria</label>
                    </div>
                    <div class="checklist-item">
                        <input type="checkbox" id="check2">
                        <label for="check2">I have filmed from the correct angle</label>
                    </div>
                    <div class="checklist-item">
                        <input type="checkbox" id="check3">
                        <label for="check3">My full body is visible throughout</label>
                    </div>
                </div>

                <a href="https://fis.instructure.com" target="_blank" class="submit-btn" id="submitBtn">
                    üì§ Submit Video on Canvas
                </a>
                <p class="submit-btn-note" id="submitBtnNote">Opens Canvas in new tab for video upload</p>
            </div>

            <!-- Strength Testing is now integrated into Level 3T in Exercise Demo -->

            <!-- ============================================ -->
            <!-- WORKOUT SECTION - VISUAL BLOCKS -->
            <!-- ============================================ -->
            <section class="workout-section" id="workoutSection">
                <div class="workout-card">
                    <div class="workout-header">
                        <div class="workout-title">
                            üèãÔ∏è Your Personal Workout Plan
                            <span class="session-badge" id="sessionBadge">Loading...</span>
                        </div>
                        <div class="workout-actions">
                            <div class="session-timer" id="sessionTimer" style="display: none;">
                                <span class="timer-icon">‚è±Ô∏è</span>
                                <div>
                                    <div class="timer-value" id="timerDisplay">00:00</div>
                                    <div class="timer-label">Session Time</div>
                                </div>
                            </div>
                            <button class="complete-session-btn" id="completeSessionBtn" onclick="attemptCompleteSession()" style="display: none;">
                                <span class="btn-icon">‚úì</span>
                                <span class="btn-text">Complete Session</span>
                            </button>
                            <button class="view-history-btn" onclick="showWorkoutHistory()">
                                üìä View History
                            </button>
                        </div>
                    </div>

                    <!-- Stats Counter -->
                    <div class="stats-counter" id="statsCounter">
                        <div class="stat-item">
                            <span class="stat-icon">üí™</span>
                            <span><span class="stat-value" id="totalSessions">0</span> Sessions</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-icon">üèãÔ∏è</span>
                            <span><span class="stat-value" id="totalReps">0</span> reps logged</span>
                        </div>
                    </div>

                    <!-- Loading State -->
                    <div class="workout-loading" id="workoutLoading">
                        <div class="spinner"></div>
                        <div class="workout-loading-text">Loading your workout plan...</div>
                        <div class="workout-loading-subtext">Fetching personalized exercises and weights</div>
                    </div>

                    <!-- Session Not Started State -->
                    <div class="session-not-started" id="sessionNotStarted" style="display: none;">
                        <div class="session-not-started-icon">üéØ</div>
                        <div class="session-not-started-title">Ready for Session <span id="nextSessionType">A</span>?</div>
                        <div class="session-not-started-text">Start your workout to begin tracking time and exercises.</div>
                        <button class="start-session-btn" onclick="startSession()">
                            <span>‚ñ∂Ô∏è</span> Start Session
                        </button>
                    </div>

                    <!-- Workout Block Container (hidden until session started) -->
                    <div class="workout-block-container" id="workoutBlockContainer" style="display: none;">
                        <div class="workout-block" id="currentBlock">
                            <!-- Dynamically filled based on current block -->
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <!-- History Modal -->
    <div class="modal-overlay" id="historyModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">üìä Workout History</h3>
                <button class="modal-close" onclick="closeHistoryModal()">√ó</button>
            </div>
            <div id="historyList">
                <!-- Filled dynamically -->
            </div>
        </div>
    </div>

    <!-- Sloth Slowdown Modal -->
    <div class="sloth-modal" id="slothModal">
        <div class="sloth-content">
            <div class="sloth-emoji">ü¶•</div>
            <div class="sloth-title">Whoa there, speedy!</div>
            <div class="sloth-message">
                Good strength training takes time.<br>
                Rest between sets. Focus on form.<br>
                Quality over speed!
            </div>
            <div class="sloth-timer" id="slothTimer">00:00</div>
            <div class="sloth-tip">
                üí° <strong>Tip:</strong> Rest 90-120 seconds between sets for optimal strength gains.
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <script>
        // ============================================
        // CONFIGURATION
        // ============================================
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyE7_ks2QVzjkBHMOhwCyfIAO4RAWg-2McEUxGJF4KfxEYV6zkhy6cUljdcE6dVGz9s/exec';
        
        // Cache settings
        const CACHE_DURATION = 5 * 60 * 1000; // 5 minutes
        let athleteDataCache = null;
        let cacheTimestamp = 0;

        // Current user
        let currentUser = null;
        let currentStrength = null;
        let currentSessionType = 'A';
        let currentSessionNumber = 1;

        // Workout session tracking
        let sessionStartTime = null;
        let sessionTimer = null;
        let exerciseData = []; // Tracks exercises with completion status and weights
        const MIN_SESSION_DURATION = 20 * 60 * 1000; // 20 minutes in ms (for final completion)
        const MIN_BLOCK_DURATION = 60 * 1000; // 60 seconds minimum per block
        const SLOTH_PAUSE_DURATION = 90 * 1000; // 90 second pause if too fast
        let blockStartTime = null; // Track when current block was started
        let slothPauseActive = false;
        let slothShown = false;

        // Session control - reads from Config sheet via API
        let maxAvailableSession = 1; // Will be fetched from config

        // Visual Block System
        let workoutBlocks = []; // Array of block objects
        let currentBlockIndex = 0;
        let currentSession = 1; // Which session they're on

        // Movement patterns data - DO NOT MODIFY exercise names, videos, or criteria without explicit approval
        const patterns = [
            { 
                key: 'Squat', 
                name: 'Squat',
                testLevel: 2,
                exercises: {
                    1: { name: 'Bodyweight Squat', video: 'https://www.youtube.com/embed/iiKn5FiVUjI' },
                    2: { name: 'Goblet Squat', video: 'https://www.youtube.com/embed/pEGfGwp6IEA' },
                    3: { name: 'Back Squat', video: 'https://www.youtube.com/embed/j-KDHkRMer0' },
                    4: { name: 'Front Squat', video: 'https://www.youtube.com/embed/ddJklKFk2yg' },
                    5: { name: 'Pistol / Squat Clean', video: 'https://www.youtube.com/embed/D934zSaVtU0' }
                },
                criteria: [
                    { text: 'Feet flat throughout', note: 'No heel rise at any point' },
                    { text: 'Knees track over toes', note: 'No valgus (inward) collapse' },
                    { text: 'Hip crease below top of knee', note: 'At the bottom of the squat' },
                    { text: 'Neutral spine maintained', note: 'No excessive rounding or arching' },
                    { text: 'Controlled descent', note: '2+ seconds down' },
                    { text: 'No excessive forward lean', note: 'Torso angle within 45¬∞' }
                ],
                loadTiers: { M: [8, 16, 24, 32, 36], F: [6, 12, 18, 24, 28] }
            },
            { 
                key: 'Push', 
                name: 'Push',
                testLevel: 2,
                exercises: {
                    1: { name: 'Floor Push Up', video: 'https://www.youtube.com/embed/Ql8PKKsDE70' },
                    2: { name: 'Dumbbell Bench Press', video: 'https://www.youtube.com/embed/ZaDlbm8E8Tg' },
                    3: { name: 'Barbell Bench Press', video: 'https://www.youtube.com/embed/ejI1Nlsul9k' },
                    4: { name: 'Single Arm DB Press', video: 'https://www.youtube.com/embed/sM9eFPV7VVA' },
                    5: { name: 'Plyo Push Up', video: 'https://www.youtube.com/embed/q3cXdiyY7-Q' }
                },
                criteria: [
                    { text: 'Full range of motion', note: 'Chest to bar/floor, full lockout' },
                    { text: 'Elbows at 45¬∞ angle', note: 'Not flared out at 90¬∞' },
                    { text: 'Shoulder blades retracted', note: 'Pinched together throughout' },
                    { text: 'Core engaged, no sagging', note: 'Body in straight line (push up)' },
                    { text: 'Controlled descent', note: 'No bouncing off chest' },
                    { text: 'Feet stable on ground', note: 'No leg drive unless intended' }
                ],
                loadTiers: { M: [8, 16, 24, 32, 40], F: [6, 12, 18, 24, 32] }
            },
            { 
                key: 'Pull', 
                name: 'Pull',
                testLevel: 2,
                testType: 'reps', // Rep-based test instead of 5RM
                exercises: {
                    1: { name: 'Banded Row', video: 'https://www.youtube.com/embed/j7ABJGauUEk' },
                    2: { name: 'Horizontal Pull / Inverted Row', video: 'https://www.youtube.com/embed/vZy_Eu_Z0WA' },
                    3: { name: 'Dumbbell Row', video: 'https://www.youtube.com/embed/aVH_cG4UISc' },
                    4: { name: 'Pull Up', video: 'https://www.youtube.com/embed/jgFel4wZl3I' },
                    5: { name: 'Weighted Pull Up / Clean Pull', video: 'https://www.youtube.com/embed/2m58VKBEQuo' }
                },
                criteria: [
                    { text: 'Full range of motion', note: 'Arm extended to fully contracted' },
                    { text: 'Shoulder blade retracts', note: 'Squeeze back at top' },
                    { text: 'No excessive body swing', note: 'Controlled movement' },
                    { text: 'Elbow drives back', note: 'Not just arm pulling' },
                    { text: 'Chest up, shoulders down', note: 'No shrugging' },
                    { text: 'Core engaged throughout', note: 'Stable torso' }
                ],
                loadTiers: { M: [5, 8, 12, 15, 20], F: [3, 5, 8, 12, 15] }
            },
            { 
                key: 'Hinge', 
                name: 'Hinge',
                testLevel: 2,
                exercises: {
                    1: { name: 'Bodyweight Hinge', video: 'https://www.youtube.com/embed/3Cb3Zvglx1U' },
                    2: { name: 'Kettlebell Deadlift', video: 'https://www.youtube.com/embed/PXJpKhdN9PM' },
                    3: { name: 'Hex Bar Deadlift', video: 'https://www.youtube.com/embed/FYx76NSijfU' },
                    4: { name: 'Barbell Deadlift', video: 'https://www.youtube.com/embed/TN3DHmd1Fe8' },
                    5: { name: 'Single Leg RDL / Power Clean', video: 'https://www.youtube.com/embed/pJewPISyHjw' }
                },
                criteria: [
                    { text: 'Spine neutral throughout', note: 'No rounding of lower back' },
                    { text: 'Hips hinge back first', note: 'Not a squat pattern' },
                    { text: 'Knees soft but not excessive bend', note: 'Roughly 15-20¬∞ knee flexion' },
                    { text: 'Weight in mid-foot/heels', note: 'Not on toes' },
                    { text: 'Shoulders over or slightly in front of bar', note: 'At start position' },
                    { text: 'Full hip extension at top', note: 'Squeeze glutes, stand tall' }
                ],
                loadTiers: { M: [8, 16, 20, 24, 28], F: [8, 16, 20, 24, 28] }
            },
            { 
                key: 'Lunge', 
                name: 'Lunge',
                testLevel: 2,
                exercises: {
                    1: { name: 'Bodyweight Lunge', video: 'https://www.youtube.com/embed/krxGoIpg9XQ' },
                    2: { name: 'Dumbbell Lunge', video: 'https://www.youtube.com/embed/9gglI77Kzq8' },
                    3: { name: 'Barbell Lunge', video: 'https://www.youtube.com/embed/Z6i2IQqTuU0' },
                    4: { name: 'Rear Foot Elevated Split Squat', video: 'https://www.youtube.com/embed/3fxmRoIE_fk' },
                    5: { name: 'Lateral Lunge / Split Jerk', video: 'https://www.youtube.com/embed/At9MCuYtvBU' }
                },
                criteria: [
                    { text: 'Front knee tracks over toes', note: 'No valgus collapse' },
                    { text: 'Back knee approaches floor', note: 'Full depth, controlled' },
                    { text: 'Torso upright', note: 'No excessive forward lean' },
                    { text: '90¬∞ angles at both knees', note: 'At bottom position' },
                    { text: 'Front heel stays down', note: 'Weight through whole foot' },
                    { text: 'Controlled throughout', note: 'No wobbling or loss of balance' }
                ],
                loadTiers: { M: [8, 16, 24, 32, 40], F: [6, 12, 18, 24, 32] }
            },
            { 
                key: 'Press', 
                name: 'Press',
                testLevel: 2,
                exercises: {
                    1: { name: 'Band Overhead Press', video: 'https://www.youtube.com/embed/1-VfJqjYquQ' },
                    2: { name: 'Dumbbell Press', video: 'https://www.youtube.com/embed/OM23fjJB3-0' },
                    3: { name: 'Barbell Press', video: 'https://www.youtube.com/embed/I7ND5OficOo' },
                    4: { name: 'Push Press', video: 'https://www.youtube.com/embed/MmjM11GJPAM' },
                    5: { name: 'Single Arm OH / Jerk', video: 'https://www.youtube.com/embed/FUwme_oBDsA' }
                },
                criteria: [
                    { text: 'Full lockout overhead', note: 'Arms fully extended' },
                    { text: 'Bar path straight', note: 'Head moves back, not bar forward' },
                    { text: 'Core braced throughout', note: 'No excessive back arch' },
                    { text: 'Elbows in front of bar', note: 'At start position' },
                    { text: 'Controlled descent', note: 'Back to shoulders with control' },
                    { text: 'Feet stay planted', note: 'No stepping (unless push press)' }
                ],
                loadTiers: { M: [6, 14, 24, 32, 36], F: [4, 10, 18, 24, 28] }
            }
        ];

        let selectedPattern = patterns[0];
        let selectedLevel = 1;

        // ============================================
        // PARTICLES
        // ============================================
        function createParticles() {
            const container = document.getElementById('particles');
            for (let i = 0; i < 50; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.animationDelay = Math.random() * 20 + 's';
                particle.style.animationDuration = (15 + Math.random() * 10) + 's';
                container.appendChild(particle);
            }
        }
        createParticles();

        // ============================================
        // GOOGLE SIGN-IN
        // ============================================
        function handleCredentialResponse(response) {
            const payload = JSON.parse(atob(response.credential.split('.')[1]));
            
            currentUser = {
                email: payload.email,
                name: payload.name,
                picture: payload.picture
            };

            // Save to sessionStorage for persistence across refresh
            sessionStorage.setItem('athleteUser', JSON.stringify(currentUser));

            console.log('Signed in as:', currentUser.email);
            
            document.getElementById('loadingContainer').classList.add('active');
            document.getElementById('loadingText').textContent = `Welcome, ${currentUser.name.split(' ')[0]}!`;
            
            loadPortal();
        }

        // Check for existing session on page load
        function checkExistingSession() {
            const savedUser = sessionStorage.getItem('athleteUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                console.log('Restored session for:', currentUser.email);
                document.getElementById('loadingContainer').classList.add('active');
                document.getElementById('loadingText').textContent = `Welcome back, ${currentUser.name.split(' ')[0]}!`;
                loadPortal();
                return true;
            }
            return false;
        }

        // Run session check when page loads
        window.addEventListener('load', function() {
            // Small delay to let Google Sign-In initialize
            setTimeout(() => {
                if (!currentUser) {
                    checkExistingSession();
                }
            }, 500);
        });

        // ============================================
        // DATA FETCHING
        // ============================================
        async function fetchAthleteData(email) {
            if (athleteDataCache && (Date.now() - cacheTimestamp) < CACHE_DURATION) {
                console.log('Using cached data');
                return athleteDataCache;
            }

            try {
                const url = `${APPS_SCRIPT_URL}?action=getAthleteData&email=${encodeURIComponent(email)}`;
                console.log('Fetching from:', url);
                
                const response = await fetch(url);
                const data = await response.json();
                
                console.log('Received data:', data);
                
                if (data.authenticated || data.success) {
                    athleteDataCache = data;
                    cacheTimestamp = Date.now();
                    return data;
                } else {
                    console.error('API error:', data.error);
                    return null;
                }
            } catch (error) {
                console.error('Fetch error:', error);
                return null;
            }
        }

        async function fetchLastSession(email) {
            try {
                const url = `${APPS_SCRIPT_URL}?action=getLastSession&email=${encodeURIComponent(email)}`;
                const response = await fetch(url);
                const data = await response.json();
                return data.success ? data.lastSession : null;
            } catch (error) {
                console.error('Error fetching last session:', error);
                return null;
            }
        }

        async function fetchWorkoutHistory(email, limit = 10) {
            try {
                const url = `${APPS_SCRIPT_URL}?action=getWorkoutHistory&email=${encodeURIComponent(email)}&limit=${limit}`;
                const response = await fetch(url);
                const data = await response.json();
                return data.success ? data.history : [];
            } catch (error) {
                console.error('Error fetching history:', error);
                return [];
            }
        }

        // ============================================
        // PORTAL RENDERING
        // ============================================
        async function loadPortal() {
            const data = await fetchAthleteData(currentUser.email);
            
            console.log('loadPortal - data received:', data);
            
            document.getElementById('welcomeScreen').style.display = 'none';
            document.getElementById('portal').classList.add('active');
            document.getElementById('userName').textContent = currentUser.name;

            // Strength is nested inside athlete object, also get gender from athlete
            const strength = data?.athlete?.strength || {};
            const gender = data?.athlete?.Gender || 'M';
            console.log('loadPortal - strength:', strength, 'gender:', gender);
            
            if (strength) {
                // Add gender to currentStrength for use in 3T level
                currentStrength = { ...strength, Gender: gender };
                renderProgressGrid(strength);
                // Select first pattern properly (calculates correct level)
                // Use setTimeout to ensure DOM is updated
                setTimeout(() => selectPattern(0), 0);
            } else {
                console.log('loadPortal - NO strength data found');
            }

            // Load workout plan
            loadWorkoutPlan();
        }

        function renderProgressGrid(strength) {
            console.log('renderProgressGrid called with:', strength);
            const container = document.getElementById('progressGrid');
            console.log('progressGrid container:', container);
            container.innerHTML = '';

            patterns.forEach((pattern, index) => {
                // API returns Squat_Tech, Push_Tech, etc. (capitalized)
                const techKey = pattern.name + '_Tech';
                const strKey = pattern.name + '_Str';
                const techLevel = parseInt(strength?.[techKey]) || 0;
                const strengthTier = parseInt(strength?.[strKey]) || 0;
                
                // Determine display state
                const hasStrength = strengthTier > 0;
                const isReadyToTest = techLevel >= 2 && !hasStrength;
                
                const card = document.createElement('div');
                card.className = `progress-card ${index === 0 ? 'active' : ''}`;
                card.onclick = () => selectPattern(index);
                
                if (isReadyToTest) {
                    // Special TESTING box - amber/gold theme
                    card.style.cssText = 'background: linear-gradient(135deg, rgba(245, 158, 11, 0.2), rgba(217, 119, 6, 0.1)); border-color: rgba(245, 158, 11, 0.5); box-shadow: 0 0 15px rgba(245, 158, 11, 0.2);';
                    card.innerHTML = `
                        <div class="progress-pattern" style="color: #f59e0b;">${pattern.name.toUpperCase()}</div>
                        <div class="progress-level" style="color: #f59e0b; font-size: 1.5rem;">‚ö°</div>
                        <div class="progress-label" style="color: #fbbf24; font-weight: 600;">TESTING</div>
                    `;
                } else {
                    // Show COMPLETED tech level (what's stored in the sheet)
                    card.innerHTML = `
                        <div class="progress-pattern">${pattern.name.toUpperCase()}</div>
                        <div class="progress-level">${techLevel}</div>
                        <div class="progress-label">Tech Level</div>
                    `;
                }
                container.appendChild(card);
            });
        }

        function selectPattern(index) {
            selectedPattern = patterns[index];
            const techKey = selectedPattern.name + '_Tech';
            const strKey = selectedPattern.name + '_Str';
            const techLevel = parseInt(currentStrength?.[techKey]) || 0;
            const strengthTier = parseInt(currentStrength?.[strKey]) || 0;
            const hasStrength = strengthTier > 0;
            
            // Determine what level to show
            if (techLevel >= 2 && !hasStrength) {
                // Ready to test (passed Level 2, no strength score yet)
                selectedLevel = 'TEST';
            } else if (techLevel >= 5) {
                // Max level reached
                selectedLevel = 5;
            } else {
                // Show the NEXT level they're working toward
                selectedLevel = techLevel + 1;
            }

            // Update active state
            document.querySelectorAll('.progress-card').forEach((card, i) => {
                card.classList.toggle('active', i === index);
            });

            updateSelectedPattern();
        }
        
        function scrollToAssessmentAndSelect(patternIndex) {
            // Scroll to the Movement Assessment section
            const assessmentSection = document.getElementById('movementAssessment');
            if (assessmentSection) {
                assessmentSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
            
            // Select the pattern after a short delay to allow scroll
            setTimeout(() => {
                selectPattern(patternIndex);
            }, 300);
        }

        function updateSelectedPattern() {
            const techKey = selectedPattern.name + '_Tech';
            const strKey = selectedPattern.name + '_Str';
            const completedLevel = parseInt(currentStrength?.[techKey]) || 0;
            const strengthTier = parseInt(currentStrength?.[strKey]) || 0;
            const gender = currentStrength?.Gender || 'M'; // Default to M if not set
            
            document.getElementById('patternName').textContent = selectedPattern.name;
            document.getElementById('currentLevel').textContent = selectedLevel;
            
            // Handle TEST (Strength Test) level
            if (selectedLevel === 'TEST') {
                renderTestLevel(completedLevel, strengthTier, gender);
                return;
            }
            
            // Get exercise from new structure (exercises is object with level keys)
            const exercise = selectedPattern.exercises[selectedLevel];
            
            // Determine if this level is completed, current target, or locked
            const isCompleted = selectedLevel <= completedLevel;
            const isCurrentTarget = selectedLevel === completedLevel + 1;
            const isLocked = selectedLevel > completedLevel + 1;
            
            // Build exercise name with badge - only show CURRENT TARGET, never COMPLETED
            // (because we're showing what they're working ON, not what they've done)
            let exerciseDisplay = exercise ? exercise.name : '‚Äî';
            if (isCurrentTarget) {
                exerciseDisplay += ' <span style="background: #3b82f6; color: white; font-size: 0.7rem; padding: 2px 8px; border-radius: 10px; margin-left: 8px;">CURRENT TARGET</span>';
            } else if (isLocked) {
                exerciseDisplay += ' <span style="background: #6b7280; color: white; font-size: 0.7rem; padding: 2px 8px; border-radius: 10px; margin-left: 8px;">üîí LOCKED</span>';
            } else if (selectedLevel === 5 && completedLevel >= 5) {
                exerciseDisplay += ' <span style="background: #22c55e; color: white; font-size: 0.7rem; padding: 2px 8px; border-radius: 10px; margin-left: 8px;">‚úì MASTERED</span>';
            }
            document.getElementById('exerciseName').innerHTML = exerciseDisplay;
            
            // Update video placeholder
            const videoPlaceholder = document.getElementById('videoPlaceholder');
            
            if (isLocked) {
                // Show locked message instead of video
                videoPlaceholder.innerHTML = `
                    <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: rgba(255,255,255,0.5);">
                        <span style="font-size: 3rem; margin-bottom: 15px;">üîí</span>
                        <p style="font-size: 1.1rem; font-weight: 600; color: rgba(255,255,255,0.7);">Level ${selectedLevel} Locked</p>
                        <p style="font-size: 0.9rem; margin-top: 8px;">Complete Level ${completedLevel + 1} first to unlock</p>
                        <p style="font-size: 0.85rem; margin-top: 15px; color: rgba(255,255,255,0.4);">Your current level: <strong>${completedLevel}</strong></p>
                    </div>
                `;
            } else if (exercise && exercise.video) {
                const videoId = exercise.video.replace('https://www.youtube.com/embed/', '');
                const thumbnailUrl = `https://img.youtube.com/vi/${videoId}/hqdefault.jpg`;
                const watchUrl = `https://www.youtube.com/watch?v=${videoId}`;
                
                videoPlaceholder.innerHTML = `
                    <a href="${watchUrl}" target="_blank" style="display: block; width: 100%; height: 100%; position: relative;">
                        <img src="${thumbnailUrl}" alt="${exercise.name}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 12px;">
                        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 60px; height: 60px; background: rgba(0,0,0,0.7); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                            <span style="color: white; font-size: 24px; margin-left: 4px;">‚ñ∂</span>
                        </div>
                        <div style="position: absolute; bottom: 10px; right: 10px; background: rgba(0,0,0,0.7); color: white; padding: 5px 10px; border-radius: 5px; font-size: 0.75rem;">Watch on YouTube ‚Üó</div>
                        ${isCompleted ? '<div style="position: absolute; top: 10px; left: 10px; background: #22c55e; color: white; padding: 5px 12px; border-radius: 5px; font-size: 0.75rem; font-weight: 600;">‚úì Level Completed</div>' : ''}
                    </a>
                `;
            } else {
                videoPlaceholder.innerHTML = `
                    <span>üé¨</span>
                    <p>Video coming soon</p>
                `;
            }
            
            // Show/hide level 5 warning (only if not locked)
            document.getElementById('level5Warning').style.display = (selectedLevel === 5 && !isLocked) ? 'block' : 'none';
            
            // Render form criteria for this pattern (hide if locked)
            renderCriteria(isLocked);
            
            // Show filming tips and submission for technique levels, hide strength test card
            document.getElementById('filmingTipsCard').style.display = 'block';
            document.getElementById('strengthTestCard').style.display = 'none';
            document.getElementById('submissionChecklist').style.display = 'block';
            document.getElementById('submitBtn').style.display = 'inline-flex';
            document.getElementById('submitBtnNote').style.display = 'block';
        }
        
        function renderTestLevel(completedLevel, strengthTier, gender) {
            // TEST uses Level 2 exercise
            const testExercise = selectedPattern.exercises[2];
            const loadTiers = gender === 'F' ? selectedPattern.loadTiers.F : selectedPattern.loadTiers.M;
            const isLocked = completedLevel < 2; // Unlocks after passing Level 2
            const isTested = strengthTier > 0;
            const isRepBased = selectedPattern.testType === 'reps';
            const unit = isRepBased ? ' reps' : 'kg';
            
            // Convert tier number to actual weight/reps value
            const actualWeight = isTested && strengthTier > 0 ? loadTiers[strengthTier - 1] : 0;
            
            // Change the level display to "TEST" with special styling
            document.getElementById('currentLevel').innerHTML = '<span style="color: #f59e0b;">TEST</span>';
            
            // Update exercise name display with special test styling
            let exerciseDisplay = `<span style="color: #f59e0b;">üèãÔ∏è</span> ${testExercise.name}`;
            if (isTested) {
                exerciseDisplay += ` <span style="background: linear-gradient(135deg, #22c55e, #16a34a); color: white; font-size: 0.7rem; padding: 4px 10px; border-radius: 10px; margin-left: 8px; box-shadow: 0 2px 8px rgba(34, 197, 94, 0.3);">üèÜ ${actualWeight}${unit}</span>`;
            } else if (isLocked) {
                exerciseDisplay += ' <span style="background: #6b7280; color: white; font-size: 0.7rem; padding: 2px 8px; border-radius: 10px; margin-left: 8px;">üîí LOCKED</span>';
            } else {
                exerciseDisplay += ' <span style="background: linear-gradient(135deg, #f59e0b, #d97706); color: white; font-size: 0.7rem; padding: 4px 10px; border-radius: 10px; margin-left: 8px; animation: pulse 2s infinite;">‚ö° READY TO TEST</span>';
            }
            document.getElementById('exerciseName').innerHTML = exerciseDisplay;
            
            // Update video placeholder
            const videoPlaceholder = document.getElementById('videoPlaceholder');
            
            if (isLocked) {
                videoPlaceholder.innerHTML = `
                    <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; background: linear-gradient(135deg, rgba(107,114,128,0.2), rgba(75,85,99,0.2)); border-radius: 12px;">
                        <span style="font-size: 4rem; margin-bottom: 15px; filter: grayscale(100%);">üèãÔ∏è</span>
                        <p style="font-size: 1.2rem; font-weight: 600; color: rgba(255,255,255,0.7);">Strength Test Locked</p>
                        <p style="font-size: 0.9rem; margin-top: 8px; color: rgba(255,255,255,0.5);">Pass Level 2 technique first</p>
                        <div style="margin-top: 20px; padding: 10px 20px; background: rgba(255,255,255,0.1); border-radius: 20px;">
                            <span style="color: rgba(255,255,255,0.6);">Current: Level ${completedLevel}</span>
                        </div>
                    </div>
                `;
            } else {
                const videoId = testExercise.video.replace('https://www.youtube.com/embed/', '');
                const thumbnailUrl = `https://img.youtube.com/vi/${videoId}/hqdefault.jpg`;
                const watchUrl = `https://www.youtube.com/watch?v=${videoId}`;
                
                // Add golden/amber border for test level
                videoPlaceholder.innerHTML = `
                    <a href="${watchUrl}" target="_blank" style="display: block; width: 100%; height: 100%; position: relative; border-radius: 12px; overflow: hidden; ${!isTested ? 'box-shadow: 0 0 20px rgba(245, 158, 11, 0.3), inset 0 0 0 3px rgba(245, 158, 11, 0.5);' : 'box-shadow: 0 0 20px rgba(34, 197, 94, 0.3), inset 0 0 0 3px rgba(34, 197, 94, 0.5);'}">
                        <img src="${thumbnailUrl}" alt="${testExercise.name}" style="width: 100%; height: 100%; object-fit: cover;">
                        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 70px; height: 70px; background: ${isTested ? 'rgba(34, 197, 94, 0.9)' : 'rgba(245, 158, 11, 0.9)'}; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 15px rgba(0,0,0,0.3);">
                            <span style="color: white; font-size: 28px; margin-left: 4px;">‚ñ∂</span>
                        </div>
                        <div style="position: absolute; bottom: 10px; right: 10px; background: rgba(0,0,0,0.8); color: white; padding: 5px 10px; border-radius: 5px; font-size: 0.75rem;">Watch on YouTube ‚Üó</div>
                        ${isTested ? `
                            <div style="position: absolute; top: 0; left: 0; right: 0; background: linear-gradient(135deg, #22c55e, #16a34a); color: white; padding: 8px; text-align: center; font-weight: 600; font-size: 0.85rem;">
                                üèÜ TESTED: ${actualWeight}${unit}
                            </div>
                        ` : `
                            <div style="position: absolute; top: 0; left: 0; right: 0; background: linear-gradient(135deg, #f59e0b, #d97706); color: white; padding: 8px; text-align: center; font-weight: 600; font-size: 0.85rem;">
                                ‚ö° ${isRepBased ? 'MAX REPS TEST' : '5 REP MAX TEST'}
                            </div>
                        `}
                    </a>
                `;
            }
            
            // Hide level 5 warning
            document.getElementById('level5Warning').style.display = 'none';
            
            // Hide filming tips, show strength test card
            document.getElementById('filmingTipsCard').style.display = 'none';
            document.getElementById('strengthTestCard').style.display = 'block';
            
            // Hide submission checklist and button for 3T
            document.getElementById('submissionChecklist').style.display = 'none';
            document.getElementById('submitBtn').style.display = 'none';
            document.getElementById('submitBtnNote').style.display = 'none';
            
            // Render strength test content in the right panel
            const strengthTestContent = document.getElementById('strengthTestContent');
            
            if (isLocked) {
                strengthTestContent.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: rgba(255,255,255,0.5);">
                        <div style="font-size: 3rem; margin-bottom: 15px; filter: grayscale(100%);">üîí</div>
                        <p>Complete Level 2 technique to unlock</p>
                    </div>
                `;
            } else if (isTested) {
                // Tier is stored directly, no need to calculate
                let achievedTier = strengthTier;
                
                strengthTestContent.innerHTML = `
                    <div style="text-align: center; margin-bottom: 20px;">
                        <div style="font-size: 3.5rem; margin-bottom: 10px;">üèÜ</div>
                        <div style="font-size: 2.5rem; font-weight: 800; color: #22c55e; text-shadow: 0 2px 10px rgba(34, 197, 94, 0.3);">${actualWeight}${unit}</div>
                        <div style="color: rgba(255,255,255,0.6); margin-top: 5px; font-size: 0.9rem;">${isRepBased ? 'Max Reps Achieved' : '5 Rep Max Achieved'}</div>
                    </div>
                    
                    <div style="background: linear-gradient(135deg, rgba(34, 197, 94, 0.1), rgba(22, 163, 74, 0.05)); border: 1px solid rgba(34, 197, 94, 0.2); border-radius: 12px; padding: 15px;">
                        <h4 style="color: #22c55e; font-size: 0.9rem; margin-bottom: 12px; text-transform: uppercase; text-align: center; letter-spacing: 1px;">üéØ Tier ${achievedTier} Achieved</h4>
                        <div style="display: grid; grid-template-columns: repeat(${loadTiers.length}, 1fr); gap: 6px;">
                            ${loadTiers.map((w, i) => {
                                const tierNum = i + 1;
                                const isAchieved = tierNum <= achievedTier;
                                const isCurrentTier = tierNum === achievedTier;
                                return `
                                    <div style="text-align: center; padding: 8px 4px; background: ${isCurrentTier ? 'linear-gradient(135deg, rgba(34, 197, 94, 0.4), rgba(22, 163, 74, 0.3))' : isAchieved ? 'rgba(34, 197, 94, 0.15)' : 'rgba(255,255,255,0.03)'}; border-radius: 8px; border: ${isCurrentTier ? '2px solid #22c55e' : '1px solid rgba(255,255,255,0.1)'}; ${isCurrentTier ? 'box-shadow: 0 0 10px rgba(34, 197, 94, 0.3);' : ''}">
                                        <div style="font-size: 0.65rem; color: ${isAchieved ? '#22c55e' : 'rgba(255,255,255,0.4)'}; margin-bottom: 2px;">${tierNum}</div>
                                        <div style="font-size: 0.95rem; font-weight: 600; color: ${isAchieved ? '#22c55e' : 'rgba(255,255,255,0.5)'};">${w}</div>
                                        ${isCurrentTier ? '<div style="font-size: 0.6rem; color: #22c55e; margin-top: 2px;">‚òÖ</div>' : ''}
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                    
                    <div style="margin-top: 15px; font-size: 0.8rem; color: rgba(255,255,255,0.4); text-align: center;">
                        Retest after more training sessions
                    </div>
                `;
            } else {
                // Ready to test - show protocol with amber/gold theme
                // Pattern-specific cues
                const testCues = {
                    'Squat': {
                        setup: ['Feet shoulder-width', 'Weight held close to chest', 'Stay tall and braced'],
                        stopIf: ['Knees collapsing inward or heels lifting', 'Rounding or arching through the back', 'Squat depth getting shorter each rep']
                    },
                    'Push': {
                        setup: ['Feet flat, shoulders set on bench', 'Dumbbells over chest', 'Controlled lowering every rep'],
                        stopIf: ['Shoulders lifting or shifting on bench', 'Uneven pressing or elbows flaring wide', 'Bouncing weights off chest']
                    },
                    'Pull': {
                        setup: ['Body straight from shoulders to heels', 'Pull chest to the bar', 'Control every rep'],
                        stopIf: ['Hips sagging or body bending', 'Chin reaching first instead of chest', 'Shoulders shrugging toward ears']
                    },
                    'Hinge': {
                        setup: ['Feet hip-width, KB between feet', 'Push hips back, chest tall', 'Brace before lifting'],
                        stopIf: ['Back rounding or over-arching', 'Hips shooting up faster than shoulders', 'KB drifting away from body']
                    },
                    'Lunge': {
                        setup: ['Tall posture, eyes forward', 'Step under control', 'Front foot stays flat'],
                        stopIf: ['Front knee collapsing inward', 'Trunk twisting or falling forward', 'Loss of balance or rushed reps']
                    },
                    'Press': {
                        setup: ['Feet under hips, glutes tight', 'Weights at shoulder height', 'Brace before pressing'],
                        stopIf: ['Lower back arching or ribs flaring', 'Head pushing forward', 'One arm locking out before the other']
                    }
                };
                
                const cues = testCues[selectedPattern.name] || { setup: [], stopIf: [] };
                
                strengthTestContent.innerHTML = `
                    <div style="text-align: center; margin-bottom: 10px;">
                        <div style="font-size: 2rem; margin-bottom: 5px;">‚ö°</div>
                        <div style="font-size: 1rem; font-weight: 600; color: #f59e0b;">Ready to Test!</div>
                    </div>
                    
                    <div style="display: flex; align-items: center; gap: 8px; background: rgba(239, 68, 68, 0.15); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 8px; padding: 10px 12px; margin-bottom: 12px;">
                        <span style="font-size: 1.1rem;">‚ö†Ô∏è</span>
                        <span style="font-size: 0.85rem; color: #fca5a5; line-height: 1.3;">
                            <strong>Supervision required</strong> ‚Äì Request a slot from Mr. Bain
                        </span>
                    </div>
                    
                    <div style="background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(217, 119, 6, 0.05)); border: 1px solid rgba(245, 158, 11, 0.2); border-radius: 10px; padding: 12px; margin-bottom: 10px;">
                        <h4 style="color: #f59e0b; font-size: 0.75rem; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px;">üìã Protocol</h4>
                        ${isRepBased ? `
                        <ol style="margin: 0; padding-left: 16px; color: rgba(255,255,255,0.7); font-size: 0.8rem; line-height: 1.6;">
                            <li>Set up in position</li>
                            <li>Complete max reps with good form</li>
                            <li>Stop when technique breaks</li>
                            <li>Record total reps completed</li>
                        </ol>
                        ` : `
                        <ol style="margin: 0; padding-left: 16px; color: rgba(255,255,255,0.7); font-size: 0.8rem; line-height: 1.6;">
                            <li>Warm up with light sets</li>
                            <li>Start Tier 1 ‚Üí 5 clean reps</li>
                            <li>Rest 2-3 min if successful</li>
                            <li>Move to next tier</li>
                            <li>Stop when technique breaks</li>
                        </ol>
                        `}
                        <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(245, 158, 11, 0.2); font-size: 0.75rem; color: rgba(255,255,255,0.5); font-style: italic;">
                            This is a technique test, not a max lift.
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 10px;">
                        <div style="background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.2); border-radius: 8px; padding: 10px;">
                            <h4 style="color: #22c55e; font-size: 0.7rem; margin-bottom: 6px; text-transform: uppercase;">‚úì Set-up</h4>
                            <ul style="margin: 0; padding-left: 14px; color: rgba(255,255,255,0.7); font-size: 0.75rem; line-height: 1.5;">
                                ${cues.setup.map(c => `<li>${c}</li>`).join('')}
                            </ul>
                        </div>
                        <div style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.2); border-radius: 8px; padding: 10px;">
                            <h4 style="color: #ef4444; font-size: 0.7rem; margin-bottom: 6px; text-transform: uppercase;">‚úó Stop if</h4>
                            <ul style="margin: 0; padding-left: 14px; color: rgba(255,255,255,0.7); font-size: 0.75rem; line-height: 1.5;">
                                ${cues.stopIf.map(c => `<li>${c}</li>`).join('')}
                            </ul>
                        </div>
                    </div>
                    
                    <div style="background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(217, 119, 6, 0.05)); border: 1px solid rgba(245, 158, 11, 0.2); border-radius: 10px; padding: 12px;">
                        <h4 style="color: #f59e0b; font-size: 0.75rem; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px;">üí™ ${isRepBased ? 'Rep Tiers' : 'Load Tiers'}</h4>
                        <div style="display: grid; grid-template-columns: repeat(${loadTiers.length}, 1fr); gap: 4px;">
                            ${loadTiers.map((w, i) => `
                                <div style="text-align: center; padding: 6px 2px; background: rgba(245, 158, 11, 0.1); border-radius: 6px; border: 1px solid rgba(245, 158, 11, 0.2);">
                                    <div style="font-size: 0.6rem; color: #f59e0b;">${i + 1}</div>
                                    <div style="font-size: 0.85rem; font-weight: 600; color: white;">${w}</div>
                                </div>
                            `).join('')}
                        </div>
                        <div style="margin-top: 8px; font-size: 0.7rem; color: rgba(255,255,255,0.5); text-align: center;">
                            T1 = competent ‚Ä¢ T3 = strong ‚Ä¢ Higher tiers not expected
                        </div>
                    </div>
                `;
            }
        }
        
        function renderCriteria(isLocked = false) {
            const criteriaList = document.getElementById('criteriaList');
            if (!selectedPattern.criteria || isLocked) {
                criteriaList.innerHTML = isLocked ? '<p style="color: rgba(255,255,255,0.4); font-style: italic;">Complete previous levels to view criteria</p>' : '';
                return;
            }
            
            criteriaList.innerHTML = selectedPattern.criteria.map((c, i) => `
                <div style="display: flex; align-items: flex-start; gap: 12px; padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.05);">
                    <input type="checkbox" id="criteria${i}" style="width: 20px; height: 20px; accent-color: #22c55e; cursor: pointer; flex-shrink: 0; margin-top: 2px;">
                    <label for="criteria${i}" style="cursor: pointer;">
                        <span style="color: rgba(255,255,255,0.9); font-weight: 500;">${c.text}</span>
                        ${c.note ? `<span style="color: rgba(255,255,255,0.5); font-size: 0.85rem;"> ‚Äî ${c.note}</span>` : ''}
                    </label>
                </div>
            `).join('');
        }

        function changeLevel(delta) {
            // Level order: 1, 2, TEST, 3, 4, 5
            const levelOrder = [1, 2, 'TEST', 3, 4, 5];
            const currentIndex = levelOrder.indexOf(selectedLevel);
            const newIndex = Math.max(0, Math.min(levelOrder.length - 1, currentIndex + delta));
            selectedLevel = levelOrder[newIndex];
            updateSelectedPattern();
        }

        // ============================================
        // WORKOUT PLAN - VISUAL BLOCKS
        // ============================================
        // Fetch the current available session from config
        async function fetchCurrentSession() {
            try {
                const response = await fetch(`${APPS_SCRIPT_URL}?action=getConfig&key=CurrentSession`);
                const data = await response.json();
                if (data.success && data.value) {
                    return parseInt(data.value) || 1;
                }
            } catch (error) {
                console.error('Error fetching current session:', error);
            }
            return 1;
        }
        
        async function loadWorkoutPlan() {
            // Show loading state
            document.getElementById('workoutLoading').style.display = 'flex';
            document.getElementById('sessionNotStarted').style.display = 'none';
            document.getElementById('workoutBlockContainer').style.display = 'none';
            document.getElementById('sessionBadge').textContent = 'Loading...';

            try {
                // Get available session from config (set by teacher in admin panel)
                maxAvailableSession = await fetchCurrentSession();
                
                // Get last session to determine next session
                const lastSession = await fetchLastSession(currentUser.email);
                
                // Determine next session number
                let nextSessionNumber = 1;
                if (lastSession && lastSession.sessionNumber) {
                    nextSessionNumber = (parseInt(lastSession.sessionNumber) || 0) + 1;
                }
                
                // Cap at available session (can't go beyond what teacher has unlocked)
                currentSessionNumber = Math.min(nextSessionNumber, maxAvailableSession);
                
                // Alternate between A and B sessions
                currentSessionType = currentSessionNumber % 2 === 1 ? 'A' : 'B';
                currentSession = currentSessionNumber;

                // Update UI
                document.getElementById('sessionBadge').textContent = `Session ${currentSessionNumber}${currentSessionType}`;
                document.getElementById('nextSessionType').textContent = `${currentSessionNumber}${currentSessionType}`;

                // Update stats counter
                const totalSessions = currentStrength?.Total_Sessions || 0;
                const totalReps = currentStrength?.Total_Reps || 0;
                document.getElementById('totalSessions').textContent = totalSessions;
                document.getElementById('totalReps').textContent = totalReps;

                // Build workout blocks based on session type
                buildWorkoutBlocks(currentStrength, currentSessionType);

                // Hide loading, show "Start Session" state
                document.getElementById('workoutLoading').style.display = 'none';
                document.getElementById('sessionNotStarted').style.display = 'block';

            } catch (error) {
                console.error('Error loading workout plan:', error);
                document.getElementById('workoutLoading').innerHTML = `
                    <div style="color: #ef4444;">‚ö†Ô∏è Error loading workout</div>
                    <div class="workout-loading-subtext">Please refresh the page</div>
                `;
            }
        }

        function buildWorkoutBlocks(strength, sessionType) {
            workoutBlocks = [];
            
            // Session A: Squat + Push primary, Lunge + Pull accessory
            // Session B: Hinge + Pull primary, Press + Squat accessory
            let primaryPatterns, accessoryPatterns;
            
            if (sessionType === 'A') {
                primaryPatterns = ['Squat', 'Push'];
                accessoryPatterns = ['Lunge', 'Pull'];
            } else {
                primaryPatterns = ['Hinge', 'Pull'];
                accessoryPatterns = ['Press', 'Squat'];
            }

            // Block 1: Warm-up
            workoutBlocks.push({
                type: 'warmup',
                title: 'üî• WARM-UP',
                subtitle: '10-15 minutes',
                exercises: [
                    { 
                        name: 'General Warm Up', 
                        instructions: [
                            '5 minutes',
                            'Slowly raise heart rate',
                            'Light jog, bike, or row'
                        ],
                        sets: 1,
                        reps: 0,
                        completed: [false]
                    },
                    {
                        name: 'World\'s Greatest Stretch',
                        instructions: [
                            '3-5 reps each side',
                            'Lunge, rotate, reach'
                        ],
                        sets: 1,
                        reps: 0,
                        completed: [false]
                    },
                    {
                        name: 'Plyos',
                        instructions: [
                            'See Mr. Bain for guidance'
                        ],
                        sets: 1,
                        reps: 0,
                        completed: [false]
                    },
                    {
                        name: 'Prehab',
                        instructions: [
                            'See Mr. Bain for guidance'
                        ],
                        sets: 1,
                        reps: 0,
                        completed: [false]
                    }
                ]
            });

            // Primary lift blocks
            primaryPatterns.forEach((patternName, index) => {
                const pattern = patterns.find(p => p.name === patternName);
                const techKey = pattern.name + '_Tech';
                const strKey = pattern.name + '_Str';
                const techLevel = parseInt(strength?.[techKey]) || 0;
                const strengthTier = parseInt(strength?.[strKey]) || 0;
                const gender = strength?.Gender || 'M';
                
                // Look up actual weight from tier
                const loadTiers = gender === 'F' ? pattern.loadTiers.F : pattern.loadTiers.M;
                const actual5RM = strengthTier > 0 ? loadTiers[strengthTier - 1] : 0;
                
                // Exercise level: use their completed level (minimum 1)
                const exerciseLevel = Math.max(techLevel, 1);
                const exercise = pattern.exercises[exerciseLevel];
                
                // Determine training state
                let trainingState = 'technique'; // Default: working on technique
                let workingWeight = 0;
                
                // Pull is rep-based, so no weight calculation
                const isRepBased = pattern.testType === 'reps';
                
                if (techLevel >= 2 && strengthTier > 0) {
                    // Has passed Level 2 AND has strength score = loaded training
                    trainingState = 'loaded';
                    if (isRepBased) {
                        // Pull: use fixed starting weight (8kg M, 5kg F)
                        workingWeight = gender === 'F' ? 5 : 8;
                    } else {
                        workingWeight = Math.round(actual5RM * 0.7 / 2.5) * 2.5;
                    }
                } else if (techLevel >= 2 && strengthTier === 0) {
                    // Has passed Level 2 but no strength score = ready to test
                    trainingState = 'readyToTest';
                    // Suggest Tier 1 weight for practice
                    if (!isRepBased) {
                        workingWeight = loadTiers[0]; // Tier 1 entry weight
                    }
                }
                // else techLevel < 2 = technique focus (default)
                
                // Reps: 5 for readyToTest (same as test), 8 for others
                const reps = trainingState === 'readyToTest' ? 5 : 8;
                
                workoutBlocks.push({
                    type: 'primary',
                    title: `üí™ PRIMARY LIFT ${index + 1}`,
                    subtitle: patternName + ' Pattern',
                    pattern: pattern,
                    techLevel: techLevel,
                    trainingState: trainingState,
                    exercises: [{
                        name: exercise.name,
                        video: exercise.video,
                        patternName: patternName,
                        sets: 3,
                        reps: reps,
                        weight: workingWeight,
                        trainingState: trainingState,
                        completed: [false, false, false]
                    }]
                });
            });

            // Accessory lift blocks
            accessoryPatterns.forEach((patternName, index) => {
                const pattern = patterns.find(p => p.name === patternName);
                const techKey = pattern.name + '_Tech';
                const strKey = pattern.name + '_Str';
                const techLevel = parseInt(strength?.[techKey]) || 0;
                const strengthTier = parseInt(strength?.[strKey]) || 0;
                const gender = strength?.Gender || 'M';
                
                // Look up actual weight from tier
                const loadTiers = gender === 'F' ? pattern.loadTiers.F : pattern.loadTiers.M;
                const actual5RM = strengthTier > 0 ? loadTiers[strengthTier - 1] : 0;
                
                // Exercise level: use their completed level (minimum 1)
                const exerciseLevel = Math.max(techLevel, 1);
                const exercise = pattern.exercises[exerciseLevel];
                
                // Determine training state
                let trainingState = 'technique';
                let workingWeight = 0;
                
                // Pull is rep-based, so no weight calculation
                const isRepBased = pattern.testType === 'reps';
                
                if (techLevel >= 2 && strengthTier > 0) {
                    trainingState = 'loaded';
                    if (isRepBased) {
                        // Pull: use fixed starting weight (8kg M, 5kg F)
                        workingWeight = gender === 'F' ? 5 : 8;
                    } else {
                        // Accessory at 56% of 5RM (80% of 70%)
                        workingWeight = Math.round(actual5RM * 0.56 / 2.5) * 2.5;
                    }
                } else if (techLevel >= 2 && strengthTier === 0) {
                    trainingState = 'readyToTest';
                    // Suggest Tier 1 weight for practice
                    if (!isRepBased) {
                        workingWeight = loadTiers[0]; // Tier 1 entry weight
                    }
                }
                
                // Reps: 5 for readyToTest (same as test), 10 for others
                const reps = trainingState === 'readyToTest' ? 5 : 10;
                
                workoutBlocks.push({
                    type: 'accessory',
                    title: `üéØ ACCESSORY ${index + 1}`,
                    subtitle: patternName + ' Pattern',
                    pattern: pattern,
                    techLevel: techLevel,
                    trainingState: trainingState,
                    exercises: [{
                        name: exercise.name,
                        video: exercise.video,
                        patternName: patternName,
                        sets: 3,
                        reps: reps,
                        weight: workingWeight,
                        trainingState: trainingState,
                        completed: [false, false, false]
                    }]
                });
            });

            // Core block
            workoutBlocks.push({
                type: 'core',
                title: 'üßò CORE',
                subtitle: '2-3 sets each',
                exercises: [
                    {
                        name: 'Plank Hold',
                        video: 'https://www.youtube.com/embed/ao5nY7lb088',
                        instructions: [
                            'Hold for 30-60 seconds',
                            'Keep body in straight line',
                            'Engage core, squeeze glutes',
                            'Don\'t let hips sag or pike up'
                        ],
                        sets: 2,
                        reps: 1,
                        completed: [false, false]
                    },
                    {
                        name: 'Dead Bug',
                        video: 'https://www.youtube.com/embed/-VykQ1HD0Vw',
                        instructions: [
                            '10 reps each side',
                            'Keep lower back pressed to floor',
                            'Extend opposite arm and leg',
                            'Controlled movement, no rushing'
                        ],
                        sets: 2,
                        reps: 10,
                        completed: [false, false]
                    }
                ]
            });

            // Technique Practice block - show patterns that still need technique work
            const techniquePracticeExercises = [];
            patterns.forEach(pattern => {
                const techLevel = parseInt(strength?.[pattern.name + '_Tech']) || 0;
                const strTier = parseInt(strength?.[pattern.name + '_Str']) || 0;
                const hasStrength = strTier > 0;
                
                // Only include if not at max level (5) and not in testing state
                if (techLevel < 5) {
                    const isReadyToTest = techLevel >= 2 && !hasStrength;
                    
                    if (!isReadyToTest) {
                        // They're working on next level
                        const nextLevel = techLevel + 1;
                        const exercise = pattern.exercises[nextLevel];
                        if (exercise) {
                            techniquePracticeExercises.push({
                                patternKey: pattern.key,
                                patternName: pattern.name,
                                name: exercise.name,
                                level: nextLevel,
                                techLevel: techLevel
                            });
                        }
                    }
                }
            });

            if (techniquePracticeExercises.length > 0) {
                workoutBlocks.push({
                    type: 'technique',
                    title: 'üéØ TECHNIQUE PRACTICE',
                    subtitle: 'Work on your next levels',
                    exercises: techniquePracticeExercises.map(ex => ({
                        name: `${ex.patternName}: ${ex.name}`,
                        level: ex.level,
                        patternKey: ex.patternKey,
                        instructions: [
                            `Currently at Level ${ex.techLevel}`,
                            `Working towards Level ${ex.level}`,
                            'Film and submit when ready'
                        ],
                        sets: 1,
                        reps: 0,
                        completed: [false],
                        linkToAssessment: true
                    }))
                });
            }

            // Summary block
            workoutBlocks.push({
                type: 'summary',
                title: '‚úÖ SESSION COMPLETE',
                subtitle: 'Great work!'
            });
        }

        function startSession() {
            // Record start time
            sessionStartTime = Date.now();
            slothShown = false;
            currentBlockIndex = 0;
            
            // Reset all block completion states
            workoutBlocks.forEach(block => {
                if (block.exercises) {
                    block.exercises.forEach(ex => {
                        ex.completed = ex.completed.map(() => false);
                    });
                }
            });

            // Update UI
            document.getElementById('sessionNotStarted').style.display = 'none';
            document.getElementById('workoutBlockContainer').style.display = 'block';
            document.getElementById('sessionTimer').style.display = 'flex';
            document.getElementById('completeSessionBtn').style.display = 'none';

            // Start timer
            updateTimer();
            sessionTimer = setInterval(updateTimer, 1000);

            // Render first block
            renderCurrentBlock();

            showToast('Session started! Take your time.', 'success');
        }

        function updateTimer() {
            if (!sessionStartTime) return;
            
            const elapsed = Date.now() - sessionStartTime;
            const minutes = Math.floor(elapsed / 60000);
            const seconds = Math.floor((elapsed % 60000) / 1000);
            
            document.getElementById('timerDisplay').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        function renderCurrentBlock() {
            const block = workoutBlocks[currentBlockIndex];
            const container = document.getElementById('currentBlock');
            
            // Generate progress dots
            const dots = workoutBlocks.map((b, i) => {
                let dotClass = 'progress-dot';
                if (i === currentBlockIndex) dotClass += ' active';
                if (i < currentBlockIndex || isBlockComplete(i)) dotClass += ' completed';
                return `<div class="${dotClass}" onclick="goToBlock(${i})"></div>`;
            }).join('');

            if (block.type === 'summary') {
                renderSummaryBlock(container, dots);
                return;
            }

            let content = `
                <div class="block-header">
                    <button class="block-nav-btn" onclick="prevBlock()" ${currentBlockIndex === 0 ? 'disabled' : ''}>
                        ‚óÄ Back
                    </button>
                    <div class="block-title-area">
                        <div class="block-title">${block.title}</div>
                        <div class="block-subtitle">${block.subtitle}</div>
                        <div class="block-progress-dots">${dots}</div>
                    </div>
                    <button class="block-nav-btn" onclick="nextBlock()">
                        Next ‚ñ∂
                    </button>
                </div>
            `;

            // Render exercises in this block
            block.exercises.forEach((exercise, exIndex) => {
                content += renderExerciseInBlock(block, exercise, exIndex);
            });

            container.innerHTML = content;
        }

        function renderExerciseInBlock(block, exercise, exIndex) {
            let html = '';
            
            // Special handling for technique practice links
            if (exercise.linkToAssessment) {
                const patternIndex = patterns.findIndex(p => p.key === exercise.patternKey);
                html += `
                    <div class="technique-link-card" onclick="scrollToAssessmentAndSelect(${patternIndex})" style="
                        background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(139, 92, 246, 0.1));
                        border: 2px solid rgba(59, 130, 246, 0.3);
                        border-radius: 16px;
                        padding: 20px;
                        cursor: pointer;
                        transition: all 0.3s ease;
                        text-align: center;
                    " onmouseover="this.style.borderColor='rgba(59, 130, 246, 0.6)'; this.style.transform='translateY(-2px)';" onmouseout="this.style.borderColor='rgba(59, 130, 246, 0.3)'; this.style.transform='translateY(0)';">
                        <div style="font-size: 2rem; margin-bottom: 10px;">üé¨</div>
                        <div style="font-size: 1.1rem; font-weight: 600; color: #3b82f6; margin-bottom: 5px;">Level ${exercise.level}</div>
                        <div style="font-size: 0.85rem; color: rgba(255,255,255,0.6);">Tap to view exercise & criteria</div>
                    </div>
                `;
            }
            // Video thumbnail (clickable link to YouTube) or instructions
            else if (exercise.video) {
                const videoId = exercise.video.split('/embed/')[1];
                const watchUrl = `https://www.youtube.com/watch?v=${videoId}`;
                html += `
                    <a href="${watchUrl}" target="_blank" class="block-video-container" style="display: block; text-decoration: none;">
                        <div class="video-thumbnail-wrapper">
                            <img src="https://img.youtube.com/vi/${videoId}/hqdefault.jpg" alt="${exercise.name}">
                            <div class="video-play-btn"><span>‚ñ∂</span></div>
                            <div style="position: absolute; bottom: 10px; right: 10px; background: rgba(0,0,0,0.8); color: white; padding: 5px 10px; border-radius: 5px; font-size: 0.75rem;">
                                Watch on YouTube ‚Üó
                            </div>
                        </div>
                    </a>
                `;
            } else if (exercise.instructions) {
                html += `
                    <div class="block-instructions">
                        <h4>üìã ${exercise.name}</h4>
                        <ul>
                            ${exercise.instructions.map(i => `<li>${i}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }

            // Exercise info with training state badge
            let stateBadge = '';
            let topBadge = '';
            if (exercise.trainingState === 'technique') {
                stateBadge = `<div style="display: inline-block; background: rgba(245, 158, 11, 0.2); color: #fbbf24; padding: 6px 14px; border-radius: 20px; font-size: 0.85rem; margin-top: 10px;">
                    üéØ TECHNIQUE FOCUS - Pass Level 2 to unlock strength testing
                </div>`;
            } else if (exercise.trainingState === 'readyToTest') {
                // Green prominent badge at top
                topBadge = `<div style="background: linear-gradient(135deg, #22c55e, #16a34a); color: white; padding: 12px 20px; border-radius: 12px; font-size: 0.95rem; font-weight: 600; margin-bottom: 15px; text-align: center; box-shadow: 0 4px 15px rgba(34, 197, 94, 0.3);">
                    ‚úÖ READY TO TEST - See Mr. Bain before practicing!
                </div>`;
            }

            // Show top badge first if exists
            if (topBadge) {
                html += topBadge;
            }

            html += `
                <div class="block-exercise-info">
                    <div class="block-exercise-name">${exercise.name}</div>
                    <div class="block-exercise-details">
                        ${exercise.sets} ${exercise.sets === 1 ? 'set' : 'sets'} √ó ${exercise.reps || 'complete'}${exercise.reps ? ' reps' : ''}
                    </div>
                    ${exercise.patternName ? `<div class="block-exercise-pattern">${exercise.patternName} Pattern ‚Ä¢ Level ${block.techLevel}</div>` : ''}
                    ${stateBadge}
                </div>
            `;

            // Weight control (for loaded OR readyToTest with weight)
            if (exercise.weight > 0) {
                const weightLabel = exercise.trainingState === 'loaded' ? 'Working Weight (70%)' : 'Practice Weight (Tier 1)';
                html += `
                    <div class="block-weight-control">
                        <button class="block-weight-btn" onclick="adjustBlockWeight(${exIndex}, -2.5)">‚àí</button>
                        <div>
                            <div class="block-weight-display" id="weight-${exIndex}">${exercise.weight} kg</div>
                            <div class="block-weight-label">${weightLabel}</div>
                        </div>
                        <button class="block-weight-btn" onclick="adjustBlockWeight(${exIndex}, 2.5)">+</button>
                    </div>
                `;
            }

            // Sets checkboxes
            html += `<div class="sets-grid">`;
            for (let i = 0; i < exercise.sets; i++) {
                const isChecked = exercise.completed[i];
                html += `
                    <div class="set-item">
                        <div class="set-checkbox ${isChecked ? 'checked' : ''}" 
                             onclick="toggleSet(${exIndex}, ${i})">
                        </div>
                        <div class="set-label">Set ${i + 1}</div>
                        ${exercise.reps ? `<div class="set-reps">${exercise.reps} reps</div>` : ''}
                    </div>
                `;
            }
            html += `</div>`;

            // Tip based on training state
            if (block.type === 'primary' || block.type === 'accessory') {
                if (exercise.trainingState === 'technique') {
                    html += `
                        <div class="block-tip" style="background: rgba(245, 158, 11, 0.1);">
                            <div class="block-tip-text">üí° Focus on perfect form - control the movement through full range</div>
                        </div>
                    `;
                } else if (exercise.trainingState === 'loaded') {
                    html += `
                        <div class="block-tip">
                            <div class="block-tip-text">üí° Rest 90-120 seconds between sets for strength gains</div>
                        </div>
                    `;
                }
            }

            return html;
        }

        function renderSummaryBlock(container, dots) {
            // Calculate totals
            let totalRepsSession = 0;
            let completedExercises = [];
            
            workoutBlocks.forEach(block => {
                if (block.exercises) {
                    block.exercises.forEach(ex => {
                        const completedSets = ex.completed.filter(c => c).length;
                        const repsPerSet = ex.reps || 1;
                        totalRepsSession += completedSets * repsPerSet;
                        
                        if (completedSets > 0) {
                            completedExercises.push({
                                name: ex.name,
                                sets: completedSets,
                                totalSets: ex.sets,
                                weight: ex.weight || 'Bodyweight'
                            });
                        }
                    });
                }
            });

            const elapsed = sessionStartTime ? Math.round((Date.now() - sessionStartTime) / 60000) : 0;

            container.innerHTML = `
                <div class="block-header">
                    <button class="block-nav-btn" onclick="prevBlock()">‚óÄ Back</button>
                    <div class="block-title-area">
                        <div class="block-title">‚úÖ SESSION COMPLETE</div>
                        <div class="block-subtitle">Great work!</div>
                        <div class="block-progress-dots">${dots}</div>
                    </div>
                    <button class="block-nav-btn" disabled>Next ‚ñ∂</button>
                </div>

                <div class="summary-block">
                    <div class="summary-icon">üèÜ</div>
                    <div class="summary-title">Session ${currentSessionType} Complete!</div>
                    
                    <div class="summary-stats">
                        <div class="summary-stat">
                            <div class="summary-stat-value">${totalRepsSession}</div>
                            <div class="summary-stat-label">Reps Completed</div>
                        </div>
                        <div class="summary-stat">
                            <div class="summary-stat-value">${elapsed}</div>
                            <div class="summary-stat-label">Minutes</div>
                        </div>
                        <div class="summary-stat">
                            <div class="summary-stat-value">${completedExercises.length}</div>
                            <div class="summary-stat-label">Exercises</div>
                        </div>
                    </div>

                    <div class="summary-exercises">
                        ${completedExercises.map(ex => `
                            <div class="summary-exercise-item ${ex.sets === ex.totalSets ? 'completed' : ''}">
                                <span>${ex.name}</span>
                                <span>${ex.sets}/${ex.totalSets} sets @ ${ex.weight}</span>
                            </div>
                        `).join('')}
                    </div>

                    <div class="notes-section" style="margin-top: 20px;">
                        <label class="notes-label" for="workoutNotes">Session Notes (optional)</label>
                        <textarea 
                            class="notes-input" 
                            id="workoutNotes" 
                            placeholder="How did the session feel? Any adjustments needed?"
                        ></textarea>
                    </div>

                    <button class="complete-block-btn" onclick="attemptCompleteSession()">
                        ‚úì Save & Complete Session
                    </button>
                </div>
            `;
        }

        function playVideo(wrapper, videoId) {
            wrapper.innerHTML = `
                <iframe 
                    src="https://www.youtube.com/embed/${videoId}?autoplay=1" 
                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                    allowfullscreen>
                </iframe>
            `;
        }

        function toggleSet(exIndex, setIndex) {
            const block = workoutBlocks[currentBlockIndex];
            const exercise = block.exercises[exIndex];
            
            // If this is the first checkbox in the block, start timing
            const wasBlockEmpty = block.exercises.every(ex => ex.completed.every(c => !c));
            
            exercise.completed[setIndex] = !exercise.completed[setIndex];
            
            // Start block timer if first checkbox
            if (wasBlockEmpty && exercise.completed[setIndex]) {
                blockStartTime = Date.now();
            }
            
            // Check if block is now complete
            const isBlockComplete = block.exercises.every(ex => ex.completed.every(c => c));
            
            if (isBlockComplete && blockStartTime) {
                const blockDuration = Date.now() - blockStartTime;
                
                // If completed too fast (under 60 seconds) and it's not warmup, show sloth
                if (blockDuration < MIN_BLOCK_DURATION && block.type !== 'warmup' && !slothPauseActive) {
                    showBlockSlothModal();
                    return;
                }
            }
            
            renderCurrentBlock();
        }
        
        function showBlockSlothModal() {
            slothPauseActive = true;
            const modal = document.getElementById('slothModal');
            modal.classList.add('active');
            
            let remaining = SLOTH_PAUSE_DURATION;
            
            const updateTimer = () => {
                if (remaining <= 0) {
                    modal.classList.remove('active');
                    slothPauseActive = false;
                    blockStartTime = null;
                    showToast('Take your time on the next block!', 'info');
                    renderCurrentBlock();
                    return;
                }
                
                const mins = Math.floor(remaining / 60000);
                const secs = Math.floor((remaining % 60000) / 1000);
                document.getElementById('slothTimer').textContent = 
                    `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
                
                remaining -= 1000;
                setTimeout(updateTimer, 1000);
            };
            
            updateTimer();
        }

        function adjustBlockWeight(exIndex, delta) {
            const block = workoutBlocks[currentBlockIndex];
            const exercise = block.exercises[exIndex];
            exercise.weight = Math.max(0, (exercise.weight || 0) + delta);
            document.getElementById(`weight-${exIndex}`).textContent = exercise.weight + ' kg';
        }

        function prevBlock() {
            if (currentBlockIndex > 0) {
                currentBlockIndex--;
                renderCurrentBlock();
            }
        }

        function nextBlock() {
            if (currentBlockIndex < workoutBlocks.length - 1) {
                currentBlockIndex++;
                renderCurrentBlock();
            }
        }

        function goToBlock(index) {
            currentBlockIndex = index;
            renderCurrentBlock();
        }

        function isBlockComplete(blockIndex) {
            const block = workoutBlocks[blockIndex];
            if (!block.exercises) return blockIndex < currentBlockIndex;
            return block.exercises.every(ex => ex.completed.every(c => c));
        }

        // ============================================
        // COMPLETE WORKOUT WITH SLOTH CHECK
        // ============================================
        function attemptCompleteSession() {
            if (!sessionStartTime) {
                showToast('Please start a session first', 'error');
                return;
            }

            const elapsed = Date.now() - sessionStartTime;
            const remaining = MIN_SESSION_DURATION - elapsed;

            if (remaining > 0) {
                // Show sloth modal
                showSlothModal(remaining);
                return;
            }

            // Time requirement met
            completeWorkout();
        }

        function showSlothModal(remainingMs) {
            const modal = document.getElementById('slothModal');
            modal.classList.add('active');

            // Update countdown
            const updateSlothTimer = () => {
                const now = Date.now();
                const remaining = MIN_SESSION_DURATION - (now - sessionStartTime);
                
                if (remaining <= 0) {
                    modal.classList.remove('active');
                    showToast('You can now complete your session!', 'success');
                    return;
                }

                const mins = Math.floor(remaining / 60000);
                const secs = Math.floor((remaining % 60000) / 1000);
                document.getElementById('slothTimer').textContent = 
                    `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
                
                setTimeout(updateSlothTimer, 1000);
            };

            updateSlothTimer();
        }

        async function completeWorkout() {
            // Close sloth modal if open
            document.getElementById('slothModal').classList.remove('active');

            // Calculate totals from blocks
            let totalRepsSession = 0;
            const exercisesCompleted = [];
            
            workoutBlocks.forEach(block => {
                if (block.exercises) {
                    block.exercises.forEach(ex => {
                        const completedSets = ex.completed.filter(c => c).length;
                        const repsPerSet = ex.reps || 1;
                        totalRepsSession += completedSets * repsPerSet;
                        
                        if (completedSets > 0) {
                            exercisesCompleted.push({
                                name: ex.name,
                                pattern: ex.patternName || 'Core',
                                sets: completedSets,
                                reps: repsPerSet,
                                weight: ex.weight || 'bodyweight'
                            });
                        }
                    });
                }
            });

            const duration = sessionStartTime ? Math.round((Date.now() - sessionStartTime) / 60000) : 0;
            const notes = document.getElementById('workoutNotes')?.value || '';
            
            try {
                showToast('Saving session...', 'success');

                // Save to Google Sheets
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({
                        action: 'saveWorkout',
                        email: currentUser.email,
                        sessionType: currentSessionType,
                        sessionNumber: currentSessionNumber,
                        exercisesCompleted: JSON.stringify(exercisesCompleted),
                        notes: notes,
                        duration: duration,
                        totalReps: totalRepsSession
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    // Stop timer
                    if (sessionTimer) {
                        clearInterval(sessionTimer);
                        sessionTimer = null;
                    }
                    
                    showToast(`üéâ Session ${currentSessionType} complete! ${totalRepsSession} reps logged.`, 'success');
                    
                    // Update stats display
                    const currentTotal = parseInt(document.getElementById('totalSessions').textContent) || 0;
                    const currentReps = parseInt(document.getElementById('totalReps').textContent) || 0;
                    document.getElementById('totalSessions').textContent = currentTotal + 1;
                    document.getElementById('totalReps').textContent = currentReps + totalRepsSession;
                    
                    // Clear cache to get fresh data next time
                    athleteDataCache = null;
                    
                    // Reset after delay
                    setTimeout(() => {
                        sessionStartTime = null;
                        document.getElementById('sessionTimer').style.display = 'none';
                        document.getElementById('workoutBlockContainer').style.display = 'none';
                        loadWorkoutPlan(); // Reload for next session
                    }, 3000);
                    
                } else {
                    throw new Error(result.error || 'Save failed');
                }
                
            } catch (error) {
                console.error('Error completing workout:', error);
                showToast('Error saving session. Please try again.', 'error');
            }
        }

        // ============================================
        // WORKOUT HISTORY
        // ============================================
        async function showWorkoutHistory() {
            document.getElementById('historyModal').classList.add('active');
            document.getElementById('historyList').innerHTML = '<div class="no-history">Loading history...</div>';
            
            const history = await fetchWorkoutHistory(currentUser.email, 10);
            
            if (history.length === 0) {
                document.getElementById('historyList').innerHTML = '<div class="no-history">No workout history yet. Complete your first session!</div>';
                return;
            }
            
            let html = '';
            history.forEach(item => {
                const date = new Date(item.date);
                html += `
                    <div class="history-item">
                        <div class="history-date">${date.toLocaleDateString()} at ${date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
                        <div class="history-session">Session ${item.sessionType} (#${item.sessionNumber})</div>
                        ${item.notes ? `<div class="history-notes">"${item.notes}"</div>` : ''}
                    </div>
                `;
            });
            
            document.getElementById('historyList').innerHTML = html;
        }

        function closeHistoryModal() {
            document.getElementById('historyModal').classList.remove('active');
        }

        // Close modal on outside click
        document.getElementById('historyModal').addEventListener('click', function(e) {
            if (e.target === this) closeHistoryModal();
        });

        // ============================================
        // TEST CONNECTION
        // ============================================
        async function testConnection() {
            const btn = document.querySelector('.test-connection-btn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '‚è≥ Testing...';
            btn.disabled = true;
            
            try {
                const url = `${APPS_SCRIPT_URL}?action=getAthleteData&email=${encodeURIComponent(currentUser.email)}`;
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.success) {
                    btn.innerHTML = '‚úÖ Connected!';
                    btn.style.color = '#22c55e';
                    showToast('Connection successful!', 'success');
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                btn.innerHTML = '‚ùå Failed';
                btn.style.color = '#ef4444';
                showToast('Connection failed: ' + error.message, 'error');
            }
            
            setTimeout(() => {
                btn.innerHTML = originalText;
                btn.style.color = '';
                btn.disabled = false;
            }, 3000);
        }

        // ============================================
        // TOAST NOTIFICATIONS
        // ============================================
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type} active`;
            
            setTimeout(() => {
                toast.classList.remove('active');
            }, 3000);
        }
    </script>
</body>
</html>
